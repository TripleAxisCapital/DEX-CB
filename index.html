<!DOCTYPE html>
<html lang="en">
<head>
  <!-- =========================
       GLOBAL VARIABLES (UI)
       ========================= -->
  <style>
    :root{
      /* Global horizontal padding — change this or use Settings → Appearance */
      --app-x: 16px;           /* left/right padding on all pages */
      --app-maxw: 1200px;      /* content max width */
      --radius-xl: 16px;       /* card rounding */
      --radius-2xl: 20px;
      --shadow-sm: 0 1px 2px rgba(0,0,0,.05), 0 1px 1px rgba(0,0,0,.04);
      --shadow-md: 0 6px 20px rgba(0,0,0,.08);
      --brand: #0ea5e9;        /* sky-500 (Apple-esque blue) */
      --brand-2: #10b981;      /* emerald-500 */
      --ink: #0f172a;          /* slate-900 */
      --muted: #64748b;        /* slate-500 */
      --surface: #ffffff;
      --surface-2: rgba(255,255,255,.85);
      --bg: #f8fafc;           /* slate-50 */
      --border: rgba(15,23,42,.08);
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    @media (min-width: 640px){ :root{ --app-x: 24px; } }
    @media (min-width: 1024px){ :root{ --app-x: 32px; } }
  </style>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>DEX</title>

  <!-- Tailwind (CDN for single-file MVP) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/regular/style.css">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* -------- Framework-y utilities (Apple/Coinbase vibes) -------- */
    html,body{ background: var(--bg); color: var(--ink); }
    .app-shell{ padding-left: var(--app-x); padding-right: var(--app-x); max-width: var(--app-maxw); margin: 0 auto; }
    .header-blur{ backdrop-filter: saturate(140%) blur(10px); -webkit-backdrop-filter: saturate(140%) blur(10px); }
    .card{ border-radius: var(--radius-2xl); border: 1px solid var(--border); background: var(--surface-2); box-shadow: var(--shadow-sm); }
    .btn{ border-radius: 12px; padding: 10px 14px; font-weight: 600; border: 1px solid var(--border); background: #f1f5f9; transition: .2s transform, .2s background, .2s box-shadow; }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{ background: linear-gradient(180deg, #0ea5e9, #0284c7); color: #fff; border-color: #0284c7; box-shadow: 0 6px 20px rgba(2,132,199,.25); }
    .btn-primary:hover{ filter: brightness(1.02); }
    .btn-ghost{ background: transparent; }
    .chip{ display:inline-flex; align-items:center; gap:.5rem; padding:.25rem .5rem; border-radius:999px; border:1px solid var(--border); font-size:.75rem; }
    .green{ color:#059669 } .red{ color:#dc2626 }
    .pill-tab{ padding: .5rem .75rem; border-radius: 12px; border: 1px solid var(--border); font-size:.75rem; }
    .pill-tab.active{ background: #0f172a; color:#fff; border-color:#0f172a; }
    .card-pad{ padding: 20px; }
    .section-gap{ gap: 16px; }
    .kpi{ border-radius: 14px; background: #f8fafc; border:1px solid var(--border); padding: 14px; }

    /* Login loading bar (controlled by JS for one-time sync) */
    .progress-wrap{ margin-top:.75rem; width:100%; height:8px; border-radius:999px; background:#e2e8f0; overflow:hidden; }
    .progress-bar{ height:100%; width:0%; background: linear-gradient(90deg,var(--brand),#06b6d4); transition: width .35s ease; }

    /* Modal */
    .modal{ position:fixed; inset:0; z-index:60; display:flex; align-items:flex-end; justify-content:center; }
    @media (min-width:768px){ .modal{ align-items:center; } }
    .modal-bg{ position:absolute; inset:0; background:rgba(0,0,0,.45); backdrop-filter: blur(4px); }
    .modal-card{ position:relative; width:100%; max-width:760px; border-radius:20px; border:1px solid var(--border); background: var(--surface); padding:20px; }

    /* Bottom Nav (mobile) */
    .bottom-nav{ position:sticky; bottom:0; z-index:50; padding: 8px calc(var(--app-x)); background: rgba(255,255,255,.9); border-top:1px solid var(--border); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); padding-bottom: calc(8px + var(--safe-bottom)); }
    .bottom-btn{ flex:1; display:flex; gap:6px; align-items:center; justify-content:center; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#f8fafc; font-size:.8rem; }
    .bottom-btn.active{ background: #0ea5e9; color:#fff; border-color:#0284c7; }

    /* Inputs */
    .input{ width:100%; border:1px solid var(--border); border-radius:14px; padding:10px 12px; outline:none; background:#fff; }
    .input:focus{ box-shadow:0 0 0 4px rgba(14,165,233,.15); }

    /* Chart container */
    .chart-box{ height: 240px; }
    @media (min-width:1024px){ .chart-box{ height: 280px; } }

    /* Safe top for header */
    .pt-safe{ padding-top: calc(8px + var(--safe-top)); }

    /* Positions: Apple-like spacious list */
    .pos-header{ display:none; }
    @media (min-width:768px){
      .pos-header{ display:grid; grid-template-columns: 4fr 2fr 2fr 2fr 2fr; gap: 12px; font-size:.75rem; text-transform:uppercase; color:#64748b; letter-spacing:.03em; }
    }
    .pos-row{ display:grid; grid-template-columns: 1fr; gap: 10px; padding: 14px 0; }
    @media (min-width:768px){
      .pos-row{ grid-template-columns: 4fr 2fr 2fr 2fr 2fr; align-items:center; gap: 12px; }
    }
    .pos-row + .pos-row{ border-top: 1px solid var(--border); }
  </style>
</head>
<body class="min-h-screen">

  <!-- LOGIN -->
  <div id="loginOverlay" class="fixed inset-0 z-50 flex items-center justify-center"
       style="background: radial-gradient(1200px 600px at 20% -10%, #0ea5e933, transparent), radial-gradient(1200px 600px at 120% 110%, #10b98133, transparent), linear-gradient(180deg,#0b1220, #0b1220);">
    <div class="w-full max-w-sm card card-pad bg-white/90">
      <div class="flex items-center gap-3 mb-2">
        <div style="width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand-2))"></div>
        <h1 class="text-xl font-semibold tracking-tight">Sign in</h1>
      </div>

      <!-- Use a real <form> to better control autofill behavior -->
      <form id="loginForm" class="space-y-3" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false">
        <div>
          <label class="text-xs text-slate-500">Account</label>
          <input id="loginAccount"
                 class="input mt-1"
                 placeholder="Account ID"
                 inputmode="text"
                 name="account_field_unique"
                 autocomplete="off"
                 autocapitalize="off" autocorrect="off" spellcheck="false" />
        </div>
        <div>
          <label class="text-xs text-slate-500">Password</label>
          <input id="loginPass"
                 type="password"
                 class="input mt-1"
                 placeholder="Password"
                 name="password_field_unique"
                 autocomplete="new-password"
                 autocapitalize="off" autocorrect="off" spellcheck="false" />
        </div>
        <div>
          <label class="text-xs text-slate-500">Key</label>
          <input id="loginKey"
                 class="input mt-1"
                 placeholder="One-time Key"
                 inputmode="numeric"
                 name="key_field_unique"
                 autocomplete="off"
                 autocapitalize="off" autocorrect="off" spellcheck="false" />
        </div>

        <button id="loginBtn" class="btn btn-primary w-full" type="submit">Continue</button>
        <p id="loginErr" class="hidden text-sm text-rose-600">Invalid credentials.</p>
      </form>

      <!-- Post-auth loading state -->
      <div id="loginLoading" class="hidden">
        <div class="flex items-center gap-2 text-slate-700">
          <i class="ph ph-shield-check"></i>
          <span class="text-sm font-medium">Securing session…</span>
        </div>
        <div class="progress-wrap"><div id="progressBar" class="progress-bar"></div></div>
        <div id="bootLogs" class="mt-3 h-24 overflow-hidden rounded-lg bg-slate-50 border border-slate-200 p-2 text-[11px] font-mono text-slate-700"></div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="app" class="opacity-0 transition-opacity duration-300">

    <!-- Header -->
    <header class="sticky top-0 z-40 border-b border-[color:var(--border)] header-blur bg-white/80">
      <div class="app-shell pt-safe">
        <div class="h-14 md:h-16 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div style="width:28px;height:28px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--brand-2))"></div>
            <span class="text-lg font-semibold -tracking-tight">DEX</span>
            <!-- Favorites quick chips -->
            <div id="favChips" class="hidden md:flex items-center gap-2 ml-2"></div>
          </div>
          <div class="hidden md:flex items-center gap-2">
            <button id="openAssetSearch" class="btn btn-ghost" title="Search & add assets">
              <i class="ph ph-magnifying-glass"></i><span class="ml-2">Assets</span>
            </button>
            <span id="headerNLV" class="hidden md:inline text-sm font-medium px-2.5 py-1 rounded-lg bg-slate-100"></span>
            <button id="logoutBtn" class="btn">Log out</button>
          </div>
          <!-- Mobile actions -->
          <div class="md:hidden flex items-center gap-2">
            <button id="openAssetSearchMobile" class="btn btn-ghost p-2"><i class="ph ph-magnifying-glass"></i></button>
          </div>
        </div>
      </div>
    </header>

    <!-- Content -->
    <main class="app-shell py-4 md:py-6 space-y-6">

      <!-- DASHBOARD -->
      <section id="page-dashboard" class="space-y-4 md:space-y-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 section-gap">
          <div class="card card-pad col-span-2">
            <div class="flex items-center justify-between mb-3 md:mb-4">
              <h2 class="text-lg md:text-xl font-semibold">Portfolio</h2>
              <div class="text-xs md:text-sm text-slate-500">Updated <span id="lastUpdated">—</span></div>
            </div>

            <!-- Range Tabs -->
            <div class="mb-3 flex items-center justify-between gap-3">
              <div class="flex items-center gap-2">
                <button class="pill-tab active" data-range="7D">7D</button>
                <button class="pill-tab" data-range="1M">1M</button>
                <button class="pill-tab" data-range="3M">3M</button>
                <button class="pill-tab" data-range="1Y">1Y</button>
                <button class="pill-tab" data-range="ALL">All</button>
              </div>
              <div class="text-sm">
                <span class="text-slate-500">Change:</span>
                <span id="rangeChange" class="font-medium">—</span>
              </div>
            </div>

            <div class="flex flex-col lg:flex-row gap-4">
              <div class="flex-1">
                <div class="chart-box">
                  <canvas id="nlvChart"></canvas>
                </div>
              </div>
              <div class="w-full lg:w-64 space-y-3">
                <div class="kpi">
                  <div class="text-xs text-slate-500">Net Liquidation Value</div>
                  <div id="nlvValue" class="text-2xl md:text-3xl font-semibold mt-1">$—</div>
                  <div id="nlvDelta" class="text-sm mt-1">—</div>
                </div>
                <div class="kpi">
                  <div class="text-xs text-slate-500">Top Weight</div>
                  <div id="topWeight" class="text-sm mt-1">—</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Quick Swap -->
          <div class="card card-pad">
            <h2 class="text-lg font-semibold mb-3">Quick Swap</h2>
            <div class="space-y-3">
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="text-xs text-slate-500">From</label>
                  <select id="qsFrom" class="input mt-1"></select>
                </div>
                <div>
                  <label class="text-xs text-slate-500">To</label>
                  <select id="qsTo" class="input mt-1"></select>
                </div>
              </div>
              <div>
                <label class="text-xs text-slate-500">Amount (From)</label>
                <input id="qsAmt" type="number" min="0" step="0.000001" class="input mt-1" placeholder="e.g., 0.5" />
              </div>
              <div class="text-xs text-slate-600" id="qsQuote">—</div>
              <button id="qsSwap" class="btn btn-primary w-full">Swap</button>
              <div id="qsMsg" class="text-xs text-slate-500"></div>
            </div>
          </div>
        </div>

        <!-- Positions -->
        <div class="card card-pad">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold">Positions</h2>
            <div class="text-xs text-slate-500">Market data via public API</div>
          </div>

          <!-- Apple-like roomy header (desktop only) -->
          <div class="pos-header mb-2">
            <div>Asset</div>
            <div>Price / 24h</div>
            <div>Holding</div>
            <div>Value</div>
            <div>Weight</div>
          </div>

          <div id="positionsList"></div>
        </div>

        <!-- Activity / Trades -->
        <div class="card card-pad">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">Recent Activity & Trades</h2>
            <button id="exportBtn" class="btn">Export Data</button>
          </div>
          <div id="activityList" class="space-y-2 text-sm mt-3"></div>
        </div>
      </section>

      <!-- SWAP PAGE -->
      <section id="page-swap" class="hidden space-y-4">
        <div class="card card-pad">
          <h2 class="text-lg font-semibold mb-4">Swap Assets</h2>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
              <label class="text-xs text-slate-500">From</label>
              <select id="swFrom" class="input mt-1"></select>
            </div>
            <div>
              <label class="text-xs text-slate-500">To</label>
              <select id="swTo" class="input mt-1"></select>
            </div>
            <div>
              <label class="text-xs text-slate-500">Amount (From)</label>
              <input id="swAmt" type="number" min="0" step="0.000001" class="input mt-1" placeholder="e.g., 1.25" />
            </div>
            <div class="flex items-end">
              <button id="swSubmit" class="btn btn-primary w-full">Execute Swap</button>
            </div>
          </div>
          <div id="swQuote" class="text-sm text-slate-600 mt-3">—</div>
          <div id="swMsg" class="text-sm text-slate-500 mt-1"></div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="page-settings" class="hidden space-y-4">
        <div class="card card-pad">
          <h2 class="text-lg font-semibold mb-3">Settings</h2>
          <div class="text-sm text-slate-600">General preferences and account configuration.</div>
        </div>

        <div class="card card-pad space-y-3">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Advanced Controls</h3>
            <button id="unlockBtn" class="btn">Unlock</button>
          </div>
          <div id="lockedNote" class="text-sm text-slate-500">Restricted section. Enter code to manage holdings and commission.</div>

          <div id="advancedWrap" class="hidden space-y-6 mt-2">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="text-xs text-slate-500">Commission (%)</label>
                <input id="advCommission" type="number" step="0.001" class="input mt-1" />
              </div>
              <div class="flex items-end">
                <button id="advSaveBasics" class="btn btn-primary w-full">Save Commission</button>
              </div>
            </div>

            <div class="border-t border-slate-200 pt-4">
              <h4 class="font-medium mb-2">Edit Holdings</h4>
              <div id="advHoldings" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
              <button id="advSaveHoldings" class="btn mt-3">Save Holdings</button>
            </div>

            <div class="border-t border-slate-200 pt-4">
              <button id="advReset" class="btn">Reset to Defaults</button>
            </div>
          </div>
        </div>

        <!-- APPEARANCE -->
        <div class="card card-pad space-y-3">
          <h3 class="font-semibold">Appearance</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
            <div>
              <label class="text-xs text-slate-500">Global Side Padding (px)</label>
              <input id="uiPadding" type="range" min="8" max="56" step="2" class="w-full"
                     oninput="document.getElementById('uiPaddingVal').textContent = this.value+'px'">
              <div class="text-xs text-slate-500"><span id="uiPaddingVal">16px</span></div>
            </div>
            <div class="flex items-end">
              <button id="saveUI" class="btn btn-primary w-full">Save Spacing</button>
            </div>
            <div class="text-xs text-slate-500">This controls the left/right whitespace across the entire app on all pages.</div>
          </div>
        </div>
      </section>

    </main>

    <!-- Bottom Nav (mobile) -->
    <nav class="bottom-nav md:hidden">
      <div class="flex items-center gap-2">
        <button class="bottom-btn active" data-tab="dashboard"><i class="ph ph-house"></i><span>Home</span></button>
        <button class="bottom-btn" data-tab="swap"><i class="ph ph-arrows-left-right"></i><span>Swap</span></button>
        <button class="bottom-btn" data-tab="settings"><i class="ph ph-gear"></i><span>Settings</span></button>
      </div>
    </nav>
  </div>

  <!-- ASSET SEARCH MODAL -->
  <div id="assetModal" class="hidden modal">
    <div class="modal-bg" data-close-modal></div>
    <div class="modal-card">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2">
          <i class="ph ph-magnifying-glass text-slate-500"></i>
          <h3 class="font-semibold">Search Assets (CoinGecko)</h3>
        </div>
        <button class="btn" data-close-modal>Close</button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div class="md:col-span-2">
          <div class="flex items-center gap-2">
            <input id="assetSearchInput" class="input flex-1" placeholder="Search by name or symbol (e.g., 'doge', 'solana', 'bitcoin')" />
            <button id="assetSearchBtn" class="btn btn-primary"><i class="ph ph-magnifying-glass"></i><span class="ml-2 hidden sm:inline">Search</span></button>
          </div>
          <div id="assetResults" class="mt-3 max-h-80 overflow-auto divide-y divide-slate-200"></div>
        </div>

        <div>
          <div class="text-sm font-medium mb-2">Favorites</div>
          <div id="favoriteList" class="space-y-2 max-h-80 overflow-auto"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /***** CONFIG *****/
    const SECRET_SETTINGS_CODE = "admin123";

    // Core asset universe (ships by default)
    const CORE_ASSETS = [
      { id: "bitcoin",       symbol: "BTC", name: "Bitcoin" },
      { id: "ethereum",      symbol: "ETH", name: "Ethereum" },
      { id: "solana",        symbol: "SOL", name: "Solana" },
      { id: "ripple",        symbol: "XRP", name: "XRP" },
      { id: "cardano",       symbol: "ADA", name: "Cardano" },
      { id: "binancecoin",   symbol: "BNB", name: "BNB" },
      { id: "polkadot",      symbol: "DOT", name: "Polkadot" },
      { id: "chainlink",     symbol: "LINK", name: "Chainlink" },
      { id: "uniswap",       symbol: "UNI", name: "Uniswap" },
      { id: "tron",          symbol: "TRX", name: "TRON" },
    ];

    // Polling
    const PRICE_POLL_MS = 10000;

    // Storage keys
    const K = {
      AUTH: "dex_auth",
      STATE: "dex_state_v1",
      HISTORY: "dex_history_v1",   // human-readable activity log
      TRADES: "dex_trades_v1",     // structured trades
      EQUITY: "dex_equity_v1",     // [{t, nlv}]
      FAVS: "dex_favorites_v1",    // [{id,symbol,name}]
      UI: "dex_ui_v1"              // { paddingPx }
    };

    // Default state
    const defaultState = () => ({
      commissionPct: 0.30,
      holdings: {
        bitcoin: 0.25,
        ethereum: 5.0,
        solana: 100,
        ripple: 1500,
        cardano: 2000,
        binancecoin: 2,
        polkadot: 300,
        chainlink: 120,
        uniswap: 250,
        tron: 5000
      }
    });

    /***** UTIL *****/
    const $ = sel => document.querySelector(sel);
    const fmtUsd = n => n == null ? "—" : n.toLocaleString(undefined, { style: "currency", currency: "USD", maximumFractionDigits: 2 });
    const fmtPct = n => `${(n>=0?"+":"")}${n.toFixed(2)}%`;
    const clamp = (x,a,b) => Math.max(a, Math.min(b,x));
    const now = () => Date.now();

    // State & persistence
    function loadState(){ const raw=localStorage.getItem(K.STATE); return raw?JSON.parse(raw):defaultState(); }
    function saveState(s){ localStorage.setItem(K.STATE, JSON.stringify(s)); }
    function loadHistory(){ const raw=localStorage.getItem(K.HISTORY); return raw?JSON.parse(raw):[]; }
    function saveHistory(h){ localStorage.setItem(K.HISTORY, JSON.stringify(h)); }
    function loadTrades(){ const raw=localStorage.getItem(K.TRADES); return raw?JSON.parse(raw):[]; }
    function saveTrades(t){ localStorage.setItem(K.TRADES, JSON.stringify(t)); }
    function loadEquity(){ const raw=localStorage.getItem(K.EQUITY); return raw?JSON.parse(raw):[]; }
    function saveEquity(e){ localStorage.setItem(K.EQUITY, JSON.stringify(e)); }
    function loadFavs(){ const raw=localStorage.getItem(K.FAVS); return raw?JSON.parse(raw):[]; }
    function saveFavs(arr){ localStorage.setItem(K.FAVS, JSON.stringify(arr)); renderFavChips(); }
    function loadUI(){ const raw=localStorage.getItem(K.UI); return raw?JSON.parse(raw):{ paddingPx: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--app-x')) || 16 }; }
    function saveUI(u){ localStorage.setItem(K.UI, JSON.stringify(u)); }

    // Activity & trades
    function pushActivity(msg){
      const h=loadHistory(); h.unshift({t:now(),msg}); saveHistory(h.slice(0,200)); renderActivity();
    }
    function recordTrade(trade){
      const list = loadTrades(); list.unshift(trade); saveTrades(list.slice(0,500));
    }

    // Equity series (persisted)
    function recordEquityPoint(nlv, minGapMs=60_000){
      if (!isFinite(nlv)) return;
      const series = loadEquity();
      const last = series[0];
      const t = now();
      if (!last || (t - last.t) >= minGapMs || Math.abs((nlv - last.nlv)/Math.max(1,last.nlv)) > 0.002){
        series.unshift({ t, nlv: +nlv });
        saveEquity(series.slice(0,20_000));
      }
    }

    // Tradable assets = CORE + FAVS
    function getTradableAssets(){
      const favs = loadFavs();
      const map = new Map();
      CORE_ASSETS.forEach(a=>map.set(a.id,a));
      favs.forEach(a=>map.set(a.id,a));
      return Array.from(map.values());
    }
    const getSymbol = id => {
      const a = getTradableAssets().find(x=>x.id===id);
      return a?.symbol || id.toUpperCase();
    };

    /***** AUTH (Login + Boot) *****/
    const loginOverlay = $("#loginOverlay");
    const loginForm = $("#loginForm");           // <form>
    const loginLoading = $("#loginLoading");
    const bootLogsEl = $("#bootLogs");
    const progressBar = $("#progressBar");
    let bootTimer;

    // Credentials (not persisted)
    const VALID_ACCOUNT = "DCEBF009";
    const VALID_PASSWORD = "#ONYX5";
    const VALID_KEY = "336664";

    // Prevent autofill memory (extra safeguards)
    ["loginAccount","loginPass","loginKey"].forEach(id=>{
      const el = ()=>document.getElementById(id);
      document.addEventListener("DOMContentLoaded", ()=>{ if(el()) el().value=""; });
      document.addEventListener("focus", ()=>{ if(el()) el().setAttribute("autocomplete","off"); }, true);
    });

    function appendLog(line){
      const el = document.createElement("div");
      el.textContent = `> ${line}`;
      bootLogsEl.appendChild(el);
      bootLogsEl.scrollTop = bootLogsEl.scrollHeight;
    }

    // Boot lines with exchange-like phrasing
    const BOOT_LINES = [
      "Verifying device posture",
      "Negotiating TLS 1.3 + ECDHE",
      "Establishing encrypted session",
      "Fetching market tickers",
      "Subscribing to order books",
      "Syncing positions & fills",
      "Applying risk & fee schedules",
      "Preparing trading interface"
    ];

    async function runBootSequence(){
      loginForm.classList.add("hidden");
      loginLoading.classList.remove("hidden");
      bootLogsEl.innerHTML = "";
      progressBar.style.width = "0%";

      let idx = 0;
      const totalSteps = BOOT_LINES.length;
      await new Promise(res=>{
        bootTimer = setInterval(()=>{
          const line = BOOT_LINES[idx % totalSteps];
          appendLog(line + "…");
          idx++;
          const pct = Math.round((idx/totalSteps)*100);
          progressBar.style.width = pct + "%";   // one pass, synced
          if (idx >= totalSteps){
            clearInterval(bootTimer);
            setTimeout(res, 350); // allow bar transition to finish
          }
        }, 420);
      });
    }

    // Handle login
    loginForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const acct = document.getElementById("loginAccount").value.trim();
      const pass = document.getElementById("loginPass").value;
      const key  = document.getElementById("loginKey").value.trim();

      // Never persist user inputs
      const ok = (acct === VALID_ACCOUNT && pass === VALID_PASSWORD && key === VALID_KEY);
      if (ok) {
        $("#loginErr").classList.add("hidden");
        await runBootSequence();
        localStorage.setItem(K.AUTH, "1"); // only store auth flag
        loginOverlay.classList.add("hidden");
        // Clear fields explicitly
        ["loginAccount","loginPass","loginKey"].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=""; });
        boot();
      } else {
        $("#loginErr").classList.remove("hidden");
      }
    });

    /***** NAV *****/
    const tabs = document.querySelectorAll(".tab");
    document.addEventListener("click",(e)=>{
      const el = e.target.closest(".tab");
      if(!el) return;
      showPage(el.dataset.tab);
      tabs.forEach(b => b.classList.toggle("btn-primary", b===el));
    });
    function showPage(id){
      ["dashboard","swap","settings"].forEach(p=>$("#page-"+p).classList.toggle("hidden", p!==id));
      document.querySelectorAll(".bottom-btn").forEach(b=>b.classList.toggle("active", b.dataset.tab===id));
      document.querySelectorAll(".tab").forEach(b=>b.classList.toggle("btn-primary", b.dataset.tab===id));
      window.scrollTo({top:0, behavior:'smooth'});
    }
    $("#logoutBtn")?.addEventListener("click", ()=>{ localStorage.removeItem(K.AUTH); location.reload(); });
    document.querySelectorAll(".bottom-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>showPage(btn.dataset.tab));
    });

    // Mobile header search
    $("#openAssetSearchMobile")?.addEventListener("click", ()=>openAssetModal());
    $("#openAssetSearch")?.addEventListener("click", ()=>openAssetModal());

    /***** MARKET DATA *****/
    let market = {}; let lastUpdated = 0;
    async function fetchMarket() {
      const tradables = getTradableAssets();
      if (tradables.length === 0) return;
      const ids = tradables.map(a=>a.id).join(",");
      const url = `https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=${ids}&price_change_percentage=24h`;
      const res = await fetch(url, { headers: { "accept": "application/json" }});
      if (!res.ok) throw new Error("Market API error");
      const data = await res.json();
      const out = {};
      data.forEach(row => {
        out[row.id] = { price: +row.current_price, chg24: row.price_change_percentage_24h_in_currency ?? row.price_change_percentage_24h ?? 0, image: row.image };
      });
      market = out;
      lastUpdated = now();
      updateUI(true);
    }
    const priceOf = id => market[id]?.price ?? null;
    const imageOf = id => market[id]?.image ?? "";

    /***** PORTFOLIO *****/
    function calcNLV(state){
      let total = 0;
      for (const a of getTradableAssets()){
        const px = priceOf(a.id);
        if (px!=null) total += (state.holdings[a.id]||0) * px;
      }
      return total;
    }

    /***** CHART *****/
    let chart; let currentRange = "7D";
    function initChart(){
      const ctx = $("#nlvChart").getContext("2d");
      const gradient = ctx.createLinearGradient(0,0,0,260);
      gradient.addColorStop(0, "rgba(14,165,233,0.35)");
      gradient.addColorStop(1, "rgba(14,165,233,0.02)");
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [{
            label: "Portfolio",
            data: [],
            tension: 0.3, borderWidth: 2, pointRadius: 0,
            borderColor: "#0ea5e9",
            fill: true, backgroundColor: gradient
          }]
        },
        options: {
          responsive:true, maintainAspectRatio:false, animation:false,
          plugins:{ legend:{display:false}, tooltip:{mode:'index',intersect:false, callbacks:{ label: ctx => fmtUsd(ctx.parsed.y) }}},
          scales:{ x:{ display:true, ticks:{ maxTicksLimit:6 }}, y:{ ticks:{ callback:v=>"$"+(v/1000).toFixed(0)+"k" } } }
        }
      });
      refreshChart();
    }
    function rangeToMs(range){ switch(range){ case "7D": return 7*24*3600*1000; case "1M": return 30*24*3600*1000; case "3M": return 90*24*3600*1000; case "1Y": return 365*24*3600*1000; default: return Infinity; } }
    function resample(series, maxPoints=300){
      if (series.length <= maxPoints) return series; const step = Math.ceil(series.length / maxPoints);
      const out=[]; for(let i=0;i<series.length;i+=step) out.push(series[i]); return out;
    }
    function refreshChart(){
      if (!chart) return;
      const series = loadEquity();
      const cutoff = isFinite(rangeToMs(currentRange)) ? (now() - rangeToMs(currentRange)) : -Infinity;
      const filtered = series.filter(p => p.t >= cutoff).slice().reverse();
      const data = resample(filtered, 300);

      chart.data.labels = data.map(p => {
        const d=new Date(p.t);
        return (currentRange==="7D"||currentRange==="1M")
          ? (d.toLocaleDateString(undefined,{month:"short", day:"numeric"})+" "+d.toLocaleTimeString(undefined,{hour:"2-digit",minute:"2-digit"}))
          : d.toLocaleDateString(undefined,{year:"2-digit",month:"short", day:"numeric"});
      });
      chart.data.datasets[0].data = data.map(p => ({x:p.t, y:p.nlv}));
      chart.update("none");

      const first = data[0]?.nlv, last = data[data.length-1]?.nlv;
      const el = $("#rangeChange");
      if (first && last){
        const pct = (last-first)/first*100;
        el.textContent = fmtPct(pct);
        el.classList.toggle("green", pct>=0);
        el.classList.toggle("red", pct<0);
      } else { el.textContent = "—"; el.classList.remove("green","red"); }
    }
    function pushChartPoint(nlv){ recordEquityPoint(nlv); refreshChart(); }
    document.addEventListener("click", (e)=>{
      const tab = e.target.closest(".pill-tab"); if (!tab) return;
      document.querySelectorAll(".pill-tab").forEach(b=>b.classList.remove("active"));
      tab.classList.add("active"); currentRange = tab.dataset.range; refreshChart();
    });

    /***** RENDER *****/
    function populateSelects(){
      const opts = getTradableAssets().map(a => `<option value="${a.id}">${a.symbol} • ${a.name}</option>`).join("");
      ["qsFrom","qsTo","swFrom","swTo"].forEach(id => { const el=$("#"+id); el.innerHTML = opts; });
      if (!$("#qsFrom").value){ $("#qsFrom").value="bitcoin"; }
      if (!$("#qsTo").value){ $("#qsTo").value="ethereum"; }
      if (!$("#swFrom").value){ $("#swFrom").value="bitcoin"; }
      if (!$("#swTo").value){ $("#swTo").value="ethereum"; }
    }
    function renderHeader(nlv){
      $("#headerNLV").textContent = fmtUsd(nlv);
      $("#headerNLV").classList.remove("hidden");
      $("#lastUpdated").textContent = new Date(lastUpdated).toLocaleTimeString();
    }
    function renderSummary(state){
      const nlv = calcNLV(state);
      $("#nlvValue").textContent = fmtUsd(nlv);
      const series = loadEquity();
      const prev = series[1]?.nlv;
      const delta = prev!=null ? ((nlv - prev)/prev)*100 : 0;
      const dEl = $("#nlvDelta");
      dEl.textContent = (prev==null) ? "—" : fmtPct(delta);
      dEl.classList.toggle("green", delta>=0);
      dEl.classList.toggle("red", delta<0);
      renderHeader(nlv);

      const rows = getTradableAssets().map(a => {
        const px = priceOf(a.id)??0, qty = loadState().holdings[a.id]??0, v=px*qty;
        return { id:a.id, symbol:a.symbol, v };
      }).sort((x,y)=>y.v-x.v);
      const total = nlv || 1;
      const top = rows[0];
      $("#topWeight").textContent = top ? `${top.symbol} • ${(top.v/total*100).toFixed(2)}%` : "—";
    }
    function isFav(id){ return loadFavs().some(f=>f.id===id); }

    // New Apple-like list rendering
    function renderPositions(state){
      const list = $("#positionsList");
      list.innerHTML = "";
      const nlv = calcNLV(state) || 1;

      for (const a of getTradableAssets()){
        const qty = state.holdings[a.id]||0;
        const px = priceOf(a.id);
        const v = (px!=null) ? qty*px : 0;
        const weight = (v/nlv)*100;
        const chg = market[a.id]?.chg24 ?? 0;

        const row = document.createElement("div");
        row.className = "pos-row";

        row.innerHTML = `
          <!-- ASSET -->
          <div class="flex items-center gap-3">
            <img src="${imageOf(a.id) || 'https://cryptoicons.org/api/icon/btc/32'}" alt="${a.symbol}" class="w-8 h-8 rounded-lg border border-slate-200"/>
            <div class="flex-1">
              <div class="font-medium">${a.symbol}</div>
              <div class="text-xs text-slate-500">${a.name}</div>
            </div>
            <button class="chip whitespace-nowrap" data-toggle-fav="${a.id}">
              <i class="ph ${isFav(a.id)?'ph-star':'ph-star-four'}"></i>
              <span>${isFav(a.id)?'Favorited':'Favorite'}</span>
            </button>
          </div>

          <!-- PRICE / 24H -->
          <div class="flex items-baseline justify-between md:block">
            <div class="font-medium">${px!=null?fmtUsd(px):"—"}</div>
            <div class="text-xs ${chg>=0?"green":"red"} md:mt-1">${fmtPct(chg)}</div>
          </div>

          <!-- HOLDING -->
          <div>
            <div class="font-medium">${qty.toFixed(6)}</div>
            <div class="text-xs text-slate-500 md:mt-1">Holding</div>
          </div>

          <!-- VALUE -->
          <div>
            <div class="font-medium">${fmtUsd(v)}</div>
            <div class="text-xs text-slate-500 md:mt-1">Value</div>
          </div>

          <!-- WEIGHT -->
          <div class="md:text-right">
            <div class="font-medium">${weight.toFixed(2)}%</div>
            <div class="text-xs text-slate-500 md:mt-1">Weight</div>
          </div>
        `;
        list.appendChild(row);
      }

      // Fav toggle handlers
      list.querySelectorAll("[data-toggle-fav]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-toggle-fav");
          toggleFavoriteById(id);
        });
      });
    }

    function renderActivity(){
      const list = $("#activityList");
      const h = loadHistory();
      const trades = loadTrades();

      const tradeBlocks = trades.slice(0,30).map(tr=>{
        const d = new Date(tr.t).toLocaleString();
        return `<div class="flex items-center justify-between">
          <div>
            <span class="font-medium">SWAP</span>
            • ${tr.fromAmt} ${getSymbol(tr.fromId)} → ${tr.toAmt} ${getSymbol(tr.toId)}
            <span class="text-slate-500"> (fee ${tr.feePct.toFixed(2)}%, rate ${tr.rate})</span>
          </div>
          <div class="text-xs text-slate-500">${d}</div>
        </div>`;
      }).join("");
      const actBlocks = h.slice(0,50).map(e=>{
        const d = new Date(e.t).toLocaleString();
        return `<div class="flex items-center justify-between">
          <div>${e.msg}</div>
          <div class="text-xs text-slate-500">${d}</div>
        </div>`;
      }).join("");
      list.innerHTML = `
        <div class="text-xs uppercase tracking-wider text-slate-500 mb-1">Trades</div>
        <div class="space-y-2 mb-4">${tradeBlocks || '<div class="text-slate-500">No trades yet.</div>'}</div>
        <div class="text-xs uppercase tracking-wider text-slate-500 mb-1">System</div>
        <div class="space-y-2">${actBlocks || '<div class="text-slate-500">No activity yet.</div>'}</div>
      `;
    }

    /***** QUOTES & SWAPS *****/
    function quoteSwap(state, fromId, toId, fromAmt){
      const fromPx = priceOf(fromId), toPx = priceOf(toId);
      if (fromId===toId) return { ok:false, msg:"Select different assets." };
      if (fromPx==null || toPx==null) return { ok:false, msg:"No market price." };
      if (!(fromAmt>0)) return { ok:false, msg:"Enter an amount." };
      if ((state.holdings[fromId]||0) < fromAmt) return { ok:false, msg:"Insufficient balance." };
      const feePct = clamp(loadState().commissionPct, 0, 100);
      const effectiveFrom = fromAmt * (1 - feePct/100.0);
      const usdValue = effectiveFrom * fromPx;
      const toAmt = usdValue / toPx;
      return { ok:true, toAmt, feePct, usdValue, fromPx, toPx };
    }
    function doSwap(state, fromId, toId, fromAmt){
      const q = quoteSwap(state, fromId, toId, fromAmt);
      if (!q.ok) return q;
      state.holdings[fromId] -= fromAmt;
      state.holdings[toId] += q.toAmt;
      return { ok:true, ...q };
    }

    // Quick Swap UI
    function updateQuickQuote(){
      const s = loadState();
      const from = $("#qsFrom").value, to = $("#qsTo").value;
      const amt = +$("#qsAmt").value;
      const q = quoteSwap(s, from, to, amt);
      const el = $("#qsQuote");
      if (!q.ok){ el.textContent = q.msg; return; }
      el.textContent = `≈ Receive ${q.toAmt.toFixed(6)} ${getSymbol(to)} (fee ${q.feePct.toFixed(2)}%)`;
    }
    $("#qsFrom").addEventListener("change", updateQuickQuote);
    $("#qsTo").addEventListener("change", updateQuickQuote);
    $("#qsAmt").addEventListener("input", updateQuickQuote);
    $("#qsSwap").addEventListener("click", ()=>{
      const s = loadState();
      const from = $("#qsFrom").value, to = $("#qsTo").value;
      const amt = +$("#qsAmt").value;
      const res = doSwap(s, from, to, amt);
      const msg = $("#qsMsg");
      if (res.ok){
        saveState(s);
        const trade = { t: now(), fromId: from, toId: to, fromAmt: +amt, toAmt: +res.toAmt.toFixed(6), feePct: +res.feePct, rate: +(res.fromPx/res.toPx).toFixed(6) };
        recordTrade(trade);
        pushActivity(`SWAP • ${amt} ${getSymbol(from)} → ${res.toAmt.toFixed(6)} ${getSymbol(to)} (fee ${res.feePct.toFixed(2)}%)`);
        updateUI(true);
        msg.textContent = "Swap executed.";
        $("#qsAmt").value = "";
        updateQuickQuote();
      } else msg.textContent = res.msg;
    });

    // Full Swap page
    function updateSwapQuote(){
      const s = loadState();
      const from = $("#swFrom").value, to = $("#swTo").value;
      const amt = +$("#swAmt").value;
      const q = quoteSwap(s, from, to, amt);
      const el = $("#swQuote");
      if (!q.ok){ el.textContent = q.msg; return; }
      el.textContent = `Rate: 1 ${getSymbol(from)} = ${(q.fromPx/q.toPx).toFixed(6)} ${getSymbol(to)} • You’ll receive ≈ ${q.toAmt.toFixed(6)} ${getSymbol(to)} (fee ${q.feePct.toFixed(2)}%)`;
    }
    $("#swFrom").addEventListener("change", updateSwapQuote);
    $("#swTo").addEventListener("change", updateSwapQuote);
    $("#swAmt").addEventListener("input", updateSwapQuote);
    $("#swSubmit").addEventListener("click", ()=>{
      const s = loadState();
      const from = $("#swFrom").value, to = $("#swTo").value;
      const amt = +$("#swAmt").value;
      const res = doSwap(s, from, to, amt);
      const msg = $("#swMsg");
      if (res.ok){
        saveState(s);
        const trade = { t: now(), fromId: from, toId: to, fromAmt: +amt, toAmt: +res.toAmt.toFixed(6), feePct: +res.feePct, rate: +(res.fromPx/res.toPx).toFixed(6) };
        recordTrade(trade);
        pushActivity(`SWAP • ${amt} ${getSymbol(from)} → ${res.toAmt.toFixed(6)} ${getSymbol(to)} (fee ${res.feePct.toFixed(2)}%)`);
        updateUI(true);
        msg.textContent = "Swap executed.";
        $("#swAmt").value = "";
        updateSwapQuote();
      } else msg.textContent = res.msg;
    });

    /***** ADVANCED (SECRET) *****/
    const advWrap = $("#advancedWrap");
    $("#unlockBtn").addEventListener("click", ()=>{
      const code = prompt("Enter access code:");
      if (code === SECRET_SETTINGS_CODE){
        $("#lockedNote").classList.add("hidden");
        advWrap.classList.remove("hidden");
        loadAdvancedEditor();
      } else alert("Incorrect code.");
    });
    function loadAdvancedEditor(){
      const s = loadState();
      $("#advCommission").value = s.commissionPct;
      const grid = $("#advHoldings");
      grid.innerHTML = "";
      getTradableAssets().forEach(a=>{
        const wrap = document.createElement("div");
        wrap.innerHTML = `
          <div class="p-3 rounded-xl border border-slate-200 bg-white">
            <div class="flex items-center gap-2 mb-2">
              <img src="${imageOf(a.id)||''}" class="w-5 h-5 rounded-md border border-slate-200"/>
              <div class="text-sm font-medium">${a.symbol} • ${a.name}</div>
            </div>
            <input data-hold="${a.id}" type="number" step="0.000001" class="input"
              value="${s.holdings[a.id] ?? 0}">
          </div>`;
        grid.appendChild(wrap);
      });
    }
    $("#advSaveBasics").addEventListener("click", ()=>{
      const s = loadState();
      s.commissionPct = clamp(+$("#advCommission").value, 0, 100);
      saveState(s);
      pushActivity(`ADMIN • Commission set to ${s.commissionPct}%`);
      updateUI(true);
      alert("Saved.");
    });
    $("#advSaveHoldings").addEventListener("click", ()=>{
      const s = loadState();
      document.querySelectorAll("[data-hold]").forEach(inp=>{
        const id = inp.dataset.hold;
        s.holdings[id] = Math.max(0, +inp.value);
      });
      saveState(s);
      pushActivity("ADMIN • Holdings updated.");
      updateUI(true);
      alert("Saved.");
    });
    $("#advReset").addEventListener("click", ()=>{
      if (!confirm("Reset commission and all holdings to defaults?")) return;
      const s = defaultState();
      saveState(s);
      pushActivity("ADMIN • Reset to defaults.");
      loadAdvancedEditor();
      updateUI(true);
    });

    /***** FAVORITES & ASSET SEARCH *****/
    function addFavorite(asset){
      const favs = loadFavs();
      if (!favs.some(f=>f.id===asset.id)){
        favs.unshift({ id: asset.id, symbol: asset.symbol.toUpperCase(), name: asset.name });
        saveFavs(favs.slice(0,500));
        const s = loadState();
        if (s.holdings[asset.id] == null) { s.holdings[asset.id] = 0; saveState(s); }
        pushActivity(`FAVORITE • Added ${asset.symbol.toUpperCase()} (${asset.name})`);
        refreshAfterUniverseChange();
      }
    }
    function removeFavorite(id){
      const favs = loadFavs().filter(f=>f.id!==id);
      saveFavs(favs);
      pushActivity(`FAVORITE • Removed ${id}`);
      refreshAfterUniverseChange();
    }
    function toggleFavoriteById(id){
      const all = getTradableAssets();
      const found = all.find(a=>a.id===id) || {};
      if (isFav(id)) removeFavorite(id);
      else addFavorite({ id, symbol: found.symbol||id, name: found.name||id });
    }
    async function searchCoinGecko(q){
      if (!q) return [];
      const url = `https://api.coingecko.com/api/v3/search?query=${encodeURIComponent(q)}`;
      const res = await fetch(url, { headers: { "accept": "application/json" }});
      if (!res.ok) return [];
      const data = await res.json();
      return (data.coins||[]).map(c=>({ id:c.id, symbol:c.symbol.toUpperCase(), name:c.name, thumb:c.thumb }));
    }
    function openAssetModal(){
      $("#assetModal").classList.remove("hidden");
      $("#assetSearchInput").focus();
      renderFavoritesPanel();
      $("#assetResults").innerHTML = `<div class="text-slate-500 text-sm">Try searching for “pepe”, “aptos”, “litecoin”…</div>`;
    }
    function closeAssetModal(){ $("#assetModal").classList.add("hidden"); }
    document.querySelectorAll("[data-close-modal]").forEach(el=>el.addEventListener("click", closeAssetModal));
    $("#assetSearchBtn").addEventListener("click", async ()=>{
      const q = $("#assetSearchInput").value.trim();
      const list = await searchCoinGecko(q);
      renderSearchResults(list);
    });
    $("#assetSearchInput").addEventListener("keydown", async (e)=>{
      if (e.key === "Enter"){
        const q = e.currentTarget.value.trim();
        const list = await searchCoinGecko(q);
        renderSearchResults(list);
      }
    });
    function renderSearchResults(list){
      const wrap = $("#assetResults");
      if (!list.length){ wrap.innerHTML = `<div class="text-slate-500 text-sm">No results.</div>`; return; }
      wrap.innerHTML = list.slice(0,100).map(a=>`
        <div class="flex items-center justify-between py-2">
          <div class="flex items-center gap-3">
            <img src="${a.thumb}" class="w-6 h-6 rounded border border-slate-200"/>
            <div>
              <div class="font-medium text-sm">${a.symbol}</div>
              <div class="text-xs text-slate-500">${a.name}</div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            ${isFav(a.id) ? 
              `<button class="btn" data-remove-fav="${a.id}"><i class="ph ph-star"></i> Remove</button>` :
              `<button class="btn btn-primary" data-add-fav='${JSON.stringify(a)}'><i class="ph ph-star-four"></i> Add</button>`
            }
          </div>
        </div>
      `).join("");
      wrap.querySelectorAll("[data-add-fav]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const asset = JSON.parse(btn.getAttribute("data-add-fav"));
          addFavorite(asset);
          const q = $("#assetSearchInput").value.trim();
          searchCoinGecko(q).then(renderSearchResults);
        });
      });
      wrap.querySelectorAll("[data-remove-fav]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-remove-fav");
          removeFavorite(id);
          const q = $("#assetSearchInput").value.trim();
          searchCoinGecko(q).then(renderSearchResults);
        });
      });
    }
    function renderFavoritesPanel(){
      const favs = loadFavs();
      const box = $("#favoriteList");
      if (!favs.length){ box.innerHTML = `<div class="text-slate-500 text-sm">No favorites yet.</div>`; return; }
      box.innerHTML = favs.map(f=>`
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="chip"><strong>${f.symbol}</strong><span class="text-slate-500">${f.name}</span></span>
          </div>
          <div class="flex items-center gap-2">
            <button class="btn" data-remove-fav="${f.id}"><i class="ph ph-x"></i></button>
          </div>
        </div>
      `).join("");
      box.querySelectorAll("[data-remove-fav]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-remove-fav");
          removeFavorite(id);
          renderFavoritesPanel();
        });
      });
    }
    function renderFavChips(){
      const bar = $("#favChips");
      const favs = loadFavs().slice(0,6);
      if (!favs.length){ bar.classList.add("hidden"); bar.innerHTML=""; return; }
      bar.classList.remove("hidden");
      bar.innerHTML = favs.map(f=>`<span class="chip cursor-pointer" data-jump="${f.id}">${f.symbol}</span>`).join("");
      bar.querySelectorAll("[data-jump]").forEach(ch=>{
        ch.addEventListener("click", ()=>{
          $("#qsFrom").value = ch.getAttribute("data-jump");
          updateQuickQuote();
          showPage("swap");
        });
      });
    }
    async function refreshAfterUniverseChange(){
      populateSelects();
      loadAdvancedEditor();
      await fetchMarket().catch(()=>{});
      updateUI(true);
      renderFavoritesPanel();
      renderFavChips();
    }

    /***** EXPORT *****/
    $("#exportBtn").addEventListener("click", ()=>{
      const blob = new Blob([JSON.stringify({
        state: loadState(),
        trades: loadTrades(),
        activity: loadHistory(),
        equity: loadEquity(),
        favorites: loadFavs(),
        ui: loadUI()
      }, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "dex_export.json";
      a.click();
      URL.revokeObjectURL(url);
    });

    /***** UI LOOP *****/
    function updateUI(pushPoint=false){
      const s = loadState();
      renderSummary(s);
      renderPositions(s);
      if (pushPoint){ const nlv = calcNLV(s); pushChartPoint(nlv); } else { refreshChart(); }
    }

    /***** APPEARANCE (Global Padding) *****/
    function applyPadding(px){
      const val = Math.max(8, Math.min(56, +px || 16));
      document.documentElement.style.setProperty('--app-x', val+'px');
      $("#uiPadding").value = val;
      $("#uiPaddingVal").textContent = val + 'px';
    }
    $("#saveUI").addEventListener("click", ()=>{
      const px = +$("#uiPadding").value || 16;
      applyPadding(px);
      saveUI({ paddingPx: px });
      pushActivity(`APPEARANCE • Global padding set to ${px}px`);
    });

    /***** BOOT *****/
    async function boot(){
      // Apply saved UI spacing
      const ui = loadUI(); applyPadding(ui.paddingPx);

      $("#app").style.opacity = 1;
      populateSelects();
      initChart();
      renderActivity();
      renderFavChips();
      if (loadEquity().length === 0){
        const s = loadState();
        const nlv0 = calcNLV(s);
        recordEquityPoint(nlv0, 0);
      }
      try { await fetchMarket(); } catch(e){ console.warn(e); }
      updateUI(true);
      setInterval(async ()=>{ try { await fetchMarket(); } catch(e){ console.warn(e); } }, PRICE_POLL_MS);
      showPage("dashboard");
    }

    // Auto-boot if already authed
    if (localStorage.getItem(K.AUTH) === "1"){
      loginOverlay.classList.add("hidden");
      boot();
    }

    /***** EVENTS for Asset Modal *****/
    function openAssetModal(){ $("#assetModal").classList.remove("hidden"); $("#assetSearchInput").focus(); renderFavoritesPanel(); $("#assetResults").innerHTML = `<div class="text-slate-500 text-sm">Try searching for “pepe”, “aptos”, “litecoin”…</div>`; }
  </script>
</body>
</html>
