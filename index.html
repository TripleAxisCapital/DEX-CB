<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <style>
    :root{
      --app-x: 16px;
      --app-maxw: 1200px;
      --radius-xl: 16px;
      --radius-2xl: 20px;
      --shadow-sm: 0 1px 2px rgba(0,0,0,.05), 0 1px 1px rgba(0,0,0,.04);
      --shadow-md: 0 6px 20px rgba(0,0,0,.08);

      --brand: #0ea5e9;
      --brand-dark: #0284c7;
      --brand-2: #06b6d4;
      --brand-rgb: 14,165,233;

      --ink: #0f172a;
      --muted: #64748b;
      --surface: #ffffff;
      --surface-2: rgba(255,255,255,.85);
      --bg: #f8fafc;
      --border: rgba(15,23,42,.08);
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    [data-theme="dark"]{
      --ink: #e5e7eb; 
      --muted: #94a3b8; 
      --surface: #0b1220;
      --surface-2: rgba(2,6,23,.85);
      --bg: #0a0f1a;
      --border: rgba(148,163,184,.18);
    }
    @media (min-width: 640px){ :root{ --app-x: 24px; } }
    @media (min-width: 1024px){ :root{ --app-x: 32px; } }
  </style>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>DEX</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/regular/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    html,body{ background: var(--bg); color: var(--ink); }
    .app-shell{ padding-left: var(--app-x); padding-right: var(--app-x); max-width: var(--app-maxw); margin: 0 auto; }
    .header-blur{ backdrop-filter: saturate(140%) blur(10px); -webkit-backdrop-filter: saturate(140%) blur(10px); background: var(--surface-2) !important; }
    .card{ border-radius: var(--radius-2xl); border: 1px solid var(--border); background: var(--surface-2); box-shadow: var(--shadow-sm); }

    .btn{ border-radius: 12px; padding: 10px 14px; font-weight: 600; border: 1px solid var(--border); background: #f1f5f9; transition: .2s transform, .2s background, .2s box-shadow; }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{
      background: linear-gradient(180deg, var(--brand), var(--brand-dark));
      color: #fff; border-color: var(--brand-dark);
      box-shadow: 0 6px 20px rgba(var(--brand-rgb), .25);
    }
    .btn-primary:hover{ filter: brightness(1.02); }
    .btn-ghost{ background: transparent; }

    .chip{ display:inline-flex; align-items:center; gap:.5rem; padding:.25rem .5rem; border-radius:999px; border:1px solid var(--border); font-size:.75rem; }
    .green{ color:#059669 } .red{ color:#dc2626 }

    .pill-tab{ padding: .5rem .75rem; border-radius: 12px; border: 1px solid var(--border); font-size:.75rem; }
    .pill-tab.active{ background: var(--brand); color:#fff; border-color: var(--brand-dark); }

    .seg{ display:inline-flex; background:#e2e8f0; border-radius:10px; padding:4px; }
    .seg button{ padding:6px 10px; border-radius:8px; font-size:.8rem; }
    .seg button.active{ background: var(--brand); color:#fff; border: 1px solid var(--brand-dark); }
    [data-theme="dark"] .seg{ background:#1f2937; }

    .card-pad{ padding: 20px; }
    .section-gap{ gap: 16px; }
    .kpi{ border-radius: 14px; background: #f8fafc; border:1px solid var(--border); padding: 14px; }

    #nlvValue{
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-variant-numeric: tabular-nums;
    }
    #headerNLV{
      max-width: 190px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-variant-numeric: tabular-nums;
    }

    .progress-wrap{ margin-top:.75rem; width:100%; height:8px; border-radius:999px; background:#e2e8f0; overflow:hidden; }
    .progress-bar{ height:100%; width:0%; background: linear-gradient(90deg,var(--brand),var(--brand-2)); transition: width .2s ease; }

    .modal{ position:fixed; inset:0; z-index:60; display:flex; align-items:flex-end; justify-content:center; }
    @media (min-width:768px){ .modal{ align-items:center; } }
    .modal-bg{ position:absolute; inset:0; background:rgba(0,0,0,.45); backdrop-filter: blur(4px); }
    .modal-card{ position:relative; width:100%; max-width:760px; border-radius:20px; border:1px solid var(--border); background: var(--surface); padding:20px; }

    .bottom-nav{ position:sticky; bottom:0; z-index:50; padding: 8px calc(var(--app-x)); background: var(--surface-2); border-top:1px solid var(--border); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); padding-bottom: calc(8px + var(--safe-bottom)); }
    .bottom-btn{ flex:1; display:flex; gap:6px; align-items:center; justify-content:center; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#f1f5f9; font-size:.8rem; }
    .bottom-btn.active{ background: var(--brand); color:#fff; border-color: var(--brand-dark); }
    [data-theme="dark"] .bottom-btn{ background:#0b1220; color:#e5e7eb; border-color:#334155; }

    .input{ width:100%; border:1px solid var(--border); border-radius:14px; padding:10px 12px; outline:none; background:#fff; }
    .input:focus{ box-shadow:0 0 0 4px rgba(var(--brand-rgb), .15); }
    [data-theme="dark"] .input{ background:#0b1220; color:#e5e7eb; border-color:#334155; }

    .chart-box{ height: 240px; }
    @media (min-width:1024px){ .chart-box{ height: 280px; } }

    .pt-safe{ padding-top: calc(8px + var(--safe-top)); }

    .pos-header{ display:none; }
    @media (min-width:768px){
      .pos-header{ display:grid; grid-template-columns: 4fr 2fr 2fr 2fr 2fr; gap: 12px; font-size:.75rem; text-transform:uppercase; color:#64748b; letter-spacing:.03em; }
    }
    .pos-row{ display:grid; grid-template-columns: 1fr; gap: 10px; padding: 14px 0; }
    @media (min-width:768px){
      .pos-row{ grid-template-columns: 4fr 2fr 2fr 2fr 2fr; align-items:center; gap: 12px; }
    }
    .pos-row + .pos-row{ border-top: 1px solid var(--border); }

    [data-theme="dark"] .card{ background: rgba(2,6,23,.85); border-color:#334155; }
    [data-theme="dark"] .kpi{ background:#0b1220; border-color:#334155; }
    [data-theme="dark"] .btn{ background:#1f2937; color:#e5e7eb; border-color:#334155; }
    [data-theme="dark"] .btn-ghost{ background: transparent; color:#e5e7eb; }
    [data-theme="dark"] .modal-card{ background:#0b1220; border-color:#334155; }
    [data-theme="dark"] .header-blur{ background: rgba(2,6,23,.75)!important; }

    .top-nav .top-btn{ border-radius: 10px; }
    .top-nav .top-btn.active{ background: var(--brand); color:#fff; border-color: var(--brand-dark); }
  </style>
</head>
<body class="min-h-screen">

  <!-- LOGIN -->
  <div id="loginOverlay" class="fixed inset-0 z-50 flex items-center justify-center"
       style="background: radial-gradient(1200px 600px at 20% -10%, #0ea5e933, transparent), radial-gradient(1200px 600px at 120% 110%, #06b6d433, transparent), linear-gradient(180deg,#0b1220, #0b1220);">
    <div class="w-full max-w-sm card card-pad" style="background: var(--surface-2);">
      <div class="flex items-center gap-3 mb-2">
        <h1 class="text-xl font-semibold tracking-tight">Sign in</h1>
      </div>

      <form id="loginForm" class="space-y-3" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false">
        <div>
          <label class="text-xs text-slate-500">Account</label>
          <input id="loginAccount" class="input mt-1" placeholder="Account ID" inputmode="text" name="account_field_unique" autocomplete="off" />
        </div>
        <div>
          <label class="text-xs text-slate-500">Password</label>
          <input id="loginPass" type="password" class="input mt-1" placeholder="Password" name="password_field_unique" autocomplete="new-password" />
        </div>
        <div>
          <label class="text-xs text-slate-500">Key</label>
          <input id="loginKey" class="input mt-1" placeholder="One-time Key" inputmode="text" name="key_field_unique" autocomplete="off" />
        </div>

        <button id="loginBtn" class="btn btn-primary w-full" type="submit">Continue</button>
        <p id="loginErr" class="hidden text-sm text-rose-600">Invalid credentials.</p>
      </form>

      <div id="loginLoading" class="hidden">
        <div class="flex items-center gap-2 text-slate-700">
          <i class="ph ph-shield-check"></i>
          <span class="text-sm font-medium">Securing session…</span>
        </div>
        <div class="progress-wrap"><div id="progressBar" class="progress-bar"></div></div>
        <div id="bootLogs" class="mt-3 h-24 overflow-hidden rounded-lg bg-slate-50 border border-slate-200 p-2 text-[11px] font-mono text-slate-700"></div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="app" class="opacity-0 transition-opacity duration-300">

    <header class="sticky top-0 z-40 border-b border-[color:var(--border)] header-blur">
      <div class="app-shell pt-safe">
        <div class="h-14 md:h-16 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <span class="text-lg font-semibold -tracking-tight">DEX</span>
            <div class="hidden md:flex items-center gap-2 top-nav ml-3">
              <button class="btn top-btn active" data-tab="dashboard"><i class="ph ph-house mr-1"></i>Home</button>
              <button class="btn top-btn" data-tab="swap"><i class="ph ph-arrows-left-right mr-1"></i>Trade</button>
              <button class="btn top-btn" data-tab="positions"><i class="ph ph-list-bullets mr-1"></i>Positions</button>
              <button class="btn top-btn" data-tab="settings"><i class="ph ph-gear mr-1"></i>Settings</button>
            </div>
          </div>
          <div class="hidden md:flex items-center gap-4">
            <button id="openAssetSearch" class="btn btn-ghost" title="Search & add assets">
              <i class="ph ph-magnifying-glass"></i><span class="ml-2">Assets</span>
            </button>
            <span id="headerNLV" class="hidden md:inline text-sm font-medium px-2.5 py-1 rounded-lg" style="background:#e2e8f0;"></span>
            <button id="logoutBtn" class="btn">Log out</button>
          </div>
          <div class="md:hidden flex items-center gap-3">
            <button id="openAssetSearchMobile" class="btn btn-ghost p-2"><i class="ph ph-magnifying-glass"></i></button>
          </div>
        </div>
      </div>
    </header>

    <main class="app-shell py-4 md:py-6 space-y-6">

      <!-- DASHBOARD -->
      <section id="page-dashboard" class="space-y-4 md:space-y-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 section-gap">
          <div class="card card-pad col-span-2">
            <div class="flex items-center justify-between mb-3 md:mb-4">
              <h2 class="text-lg md:text-xl font-semibold">Portfolio</h2>
              <div class="text-xs md:text-sm text-slate-500">Updated <span id="lastUpdated">—</span></div>
            </div>

            <div class="mb-3 flex items-center justify-between gap-3">
              <div class="flex items-center gap-2">
                <button class="pill-tab active" data-range="7D">7D</button>
                <button class="pill-tab" data-range="1M">1M</button>
                <button class="pill-tab" data-range="3M">3M</button>
                <button class="pill-tab" data-range="1Y">1Y</button>
                <button class="pill-tab" data-range="ALL">All</button>
              </div>
              <div class="text-sm">
                <span class="text-slate-500">Change:</span>
                <span id="rangeChange" class="font-medium">—</span>
              </div>
            </div>

            <div class="flex flex-col lg:flex-row gap-4">
              <div class="flex-1">
                <div class="chart-box">
                  <canvas id="nlvChart"></canvas>
                </div>
              </div>
              <div class="w-full lg:w-64 space-y-3">
                <div class="kpi">
                  <div class="text-xs text-slate-500">Net Liquidation Value</div>
                  <div id="nlvValue" class="mt-1">$—</div>
                  <div id="nlvDelta" class="text-sm mt-1">—</div>
                </div>
                <div class="kpi">
                  <div class="text-xs text-slate-500">Top Weight</div>
                  <div id="topWeight" class="text-sm mt-1">—</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Quick Swap -->
          <div class="card card-pad">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-lg font-semibold">Quick Swap</h2>
            </div>
            <div class="space-y-3">
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="text-xs text-slate-500">From</label>
                  <select id="qsFrom" class="input mt-1"></select>
                </div>
                <div>
                  <label class="text-xs text-slate-500">To</label>
                  <select id="qsTo" class="input mt-1"></select>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="text-xs text-slate-500">Amount (From)</label>
                  <input id="qsAmtFrom" type="number" min="0" step="0.000001" class="input mt-1" placeholder="e.g., 0.5" />
                </div>
                <div>
                  <label class="text-xs text-slate-500">Amount (To)</label>
                  <input id="qsAmtTo" type="number" min="0" step="0.000001" class="input mt-1" placeholder="e.g., 2.0" />
                </div>
              </div>
              <div class="text-xs text-slate-600" id="qsQuote">—</div>
              <button id="qsSwap" class="btn btn-primary w-full">Swap</button>
              <div id="qsMsg" class="text-xs text-slate-500"></div>
            </div>
          </div>
        </div>

        <div class="card card-pad">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">Recent Activity & Trades</h2>
            <button id="exportBtn" class="btn">Export Data</button>
          </div>
          <div id="activityList" class="space-y-2 text-sm mt-3"></div>
        </div>
      </section>

      <!-- POSITIONS -->
      <section id="page-positions" class="hidden space-y-4">
        <div class="card card-pad">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold">Positions</h2>
            <div class="text-xs text-slate-500">Market data via public API</div>
          </div>

          <div class="pos-header mb-2">
            <div>Asset</div>
            <div>Price / 24h</div>
            <div>Holding</div>
            <div>Value</div>
            <div>Weight</div>
          </div>

          <div id="positionsList"></div>
        </div>
      </section>

      <!-- SWAP -->
      <section id="page-swap" class="hidden space-y-4">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div class="card card-pad lg:col-span-2">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-semibold">Trade</h2>
              <div class="seg">
                <button class="active" data-ordtype="MARKET" id="ordTypeMarket">Market</button>
                <button data-ordtype="LIMIT" id="ordTypeLimit">Limit</button>
                <button data-ordtype="STOP" id="ordTypeStop">Stop</button>
                <button data-ordtype="TRAIL" id="ordTypeTrail">Trailing</button>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div>
                <label class="text-xs text-slate-500">Pay With (Currency)</label>
                <select id="payCurrency" class="input mt-1"></select>
              </div>
              <div>
                <label class="text-xs text-slate-500">Buy Asset</label>
                <select id="buyAsset" class="input mt-1"></select>
              </div>
              <div>
                <label class="text-xs text-slate-500">Quantity to Buy</label>
                <input id="buyQty" type="number" min="0" step="0.000001" class="input mt-1" placeholder="e.g., 1.25" />
              </div>
              <div class="flex items-end">
                <div class="w-full text-xs text-slate-500 ml-2">Fee auto-applied (debited in currency)</div>
              </div>
            </div>

            <div id="limitWrap" class="hidden mt-3 grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="text-xs text-slate-500">Limit Price (Currency / 1 Buy)</label>
                <input id="limitPriceBuy" type="number" min="0" step="0.0000001" class="input mt-1" placeholder="e.g., 155.5" />
              </div>
              <div>
                <label class="text-xs text-slate-500">Time in Force</label>
                <select id="tif" class="input mt-1">
                  <option value="GTC">GTC</option>
                  <option value="IOC">IOC</option>
                </select>
              </div>
            </div>

            <div id="stopWrap" class="hidden mt-3 grid grid-cols-1 md:grid-cols-4 gap-4">
              <div>
                <label class="text-xs text-slate-500">Stop Trigger (Currency / 1 Buy)</label>
                <input id="stopPriceBuy" type="number" min="0" step="0.0000001" class="input mt-1" placeholder="e.g., 140.0" />
              </div>
              <div>
                <label class="text-xs text-slate-500">Trigger Direction</label>
                <select id="stopSide" class="input mt-1">
                  <option value="ABOVE">Above</option>
                  <option value="BELOW">Below</option>
                </select>
              </div>
              <div>
                <label class="text-xs text-slate-500">On Trigger</label>
                <select id="stopExec" class="input mt-1">
                  <option value="MARKET">Market</option>
                  <option value="LIMIT">Place Limit</option>
                </select>
              </div>
              <div id="stopLimitCell" class="hidden">
                <label class="text-xs text-slate-500">Stop-Limit Price</label>
                <input id="stopLimitPriceBuy" type="number" min="0" step="0.0000001" class="input mt-1" placeholder="e.g., 142.2" />
              </div>
            </div>

            <div id="trailWrap" class="hidden mt-3 grid grid-cols-1 md:grid-cols-4 gap-4">
              <div>
                <label class="text-xs text-slate-500">Trail Type</label>
                <select id="trailType" class="input mt-1">
                  <option value="PCT">Percent from low</option>
                  <option value="AMT">Amount from low</option>
                </select>
              </div>
              <div>
                <label class="text-xs text-slate-500">Trail Value</label>
                <input id="trailValue" type="number" min="0" step="0.0001" class="input mt-1" placeholder="e.g., 2 (or 15.5)" />
              </div>
              <div>
                <label class="text-xs text-slate-500">Activation Price (optional)</label>
                <input id="trailActivation" type="number" min="0" step="0.0000001" class="input mt-1" placeholder="start trailing ≤ this" />
              </div>
            </div>

            <div class="mt-3 text-sm text-slate-600" id="swQuote">—</div>
            <div class="mt-2 flex items-center gap-2">
              <button id="placeOrderBtn" class="btn btn-primary">Place Order</button>
              <div id="swMsg" class="text-sm text-slate-500"></div>
            </div>
          </div>

          <div class="card card-pad">
            <h3 class="font-semibold mb-3">Open Orders</h3>
            <div id="openOrders" class="space-y-2 text-sm">
              <div class="text-slate-500">No open orders.</div>
            </div>
          </div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="page-settings" class="hidden space-y-4">
        <div class="card card-pad">
          <h2 class="text-lg font-semibold mb-3">Settings</h2>
          <div class="text-sm text-slate-600">General preferences and account configuration.</div>
        </div>

        <div class="card card-pad space-y-3">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Advanced Controls</h3>
            <div class="flex items-center gap-2">
              <button id="lockBtn" class="btn hidden"><i class="ph ph-lock-key-open mr-1"></i>Lock</button>
              <button id="unlockBtn" class="btn"><i class="ph ph-lock mr-1"></i>Unlock</button>
            </div>
          </div>
          <div id="lockedNote" class="text-sm text-slate-500">Restricted section. Enter code to manage holdings, commission, security, and view debug.</div>

          <div id="advancedWrap" class="hidden space-y-6 mt-2">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="text-xs text-slate-500">Commission (%)</label>
                <input id="advCommission" type="number" step="0.001" class="input mt-1" />
              </div>
              <div class="flex items-end">
                <button id="advSaveBasics" class="btn btn-primary w-full">Save Commission</button>
              </div>
            </div>

            <div class="border-t border-slate-200 pt-4">
              <h4 class="font-medium mb-2">Edit Holdings</h4>
              <div id="advHoldings" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
              <button id="advSaveHoldings" class="btn mt-3">Save Holdings</button>
            </div>

            <div class="border-t border-slate-200 pt-4 flex items-center gap-3">
              <button id="advReset" class="btn">Reset to Defaults</button>
            </div>

            <div class="border-t border-slate-200 pt-4">
              <h4 class="font-medium mb-2">Login & Security</h4>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="text-xs text-slate-500">New Password</label>
                  <input id="secNewPass" type="password" class="input mt-1" placeholder="Set a new password" />
                </div>
                <div>
                  <label class="text-xs text-slate-500">New Key</label>
                  <input id="secNewKey" type="text" class="input mt-1" placeholder="Set a new key" />
                </div>
                <div class="flex items-end">
                  <button id="saveSecurity" class="btn btn-primary w-full">Save Security</button>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end mt-4">
                <div>
                  <label class="text-xs text-slate-500">Login Duration (seconds)</label>
                  <input id="bootSeconds" type="range" min="0.5" max="20" step="0.1" class="w-full"
                         oninput="document.getElementById('bootSecondsVal').textContent = this.value+'s'">
                  <div class="text-xs text-slate-500"><span id="bootSecondsVal">3.6s</span></div>
                </div>
                <div class="flex items-end">
                  <button id="saveBoot" class="btn btn-primary w-full">Apply Login Time</button>
                </div>
                <div class="text-xs text-slate-500">Controls how long the secure session boot takes.</div>
              </div>
            </div>

            <div class="border-t border-slate-200 pt-4">
              <h4 class="font-medium mb-2">Debug • Full Activity & Trades</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div class="p-2 rounded-lg border" style="background: var(--surface); border-color: var(--border);">
                  <div class="text-xs uppercase tracking-wider text-slate-500 mb-1">Activity (all)</div>
                  <div id="adminActivity" class="text-xs max-h-64 overflow-auto"></div>
                </div>
                <div class="p-2 rounded-lg border" style="background: var(--surface); border-color: var(--border);">
                  <div class="text-xs uppercase tracking-wider text-slate-500 mb-1">Trades (all)</div>
                  <div id="adminTrades" class="text-xs max-h-64 overflow-auto"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- APPEARANCE -->
        <div class="card card-pad space-y-4">
          <h3 class="font-semibold">Appearance</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
            <div>
              <label class="text-xs text-slate-500">Global Side Padding (px)</label>
              <input id="uiPadding" type="range" min="8" max="56" step="2" class="w-full"
                     oninput="document.getElementById('uiPaddingVal').textContent = this.value+'px'">
              <div class="text-xs text-slate-500"><span id="uiPaddingVal">16px</span></div>
            </div>
            <div class="flex items-end">
              <button id="saveUI" class="btn btn-primary w-full">Save Spacing</button>
            </div>
            <div class="text-xs text-slate-500">Left/right whitespace across the entire app.</div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
            <div>
              <label class="text-xs text-slate-500">Theme</label>
              <div class="seg mt-1" role="tablist">
                <button id="themeBtnLight" data-theme="light" class="active">Light</button>
                <button id="themeBtnDark" data-theme="dark">Dark</button>
              </div>
            </div>
            <div class="flex items-end">
              <button id="saveTheme" class="btn btn-primary w-full">Apply Theme</button>
            </div>
            <div class="text-xs text-slate-500">Switch between light and dark modes.</div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
            <div>
              <label class="text-xs text-slate-500">Accent / Brand Color</label>
              <input id="brandColor" type="color" class="mt-1 w-20 h-10 p-0 border rounded-md" />
              <div class="text-xs text-slate-500 mt-1">Applies to buttons, tabs, nav, chart, etc.</div>
            </div>
            <div class="flex items-end">
              <button id="saveBrand" class="btn btn-primary w-full">Apply Brand</button>
            </div>
            <div class="text-xs text-slate-500">Saved on your device.</div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start">
            <div>
              <label class="text-xs text-slate-500">Login Background (color or CSS gradient)</label>
              <textarea id="loginBgCss" class="input mt-1" rows="3" placeholder="e.g. linear-gradient(135deg,#0ea5e9,#9333ea) or #111827"></textarea>
              <div class="text-xs text-slate-500 mt-1">Tip: paste any valid CSS background value.</div>
            </div>
            <div>
              <label class="text-xs text-slate-500">Quick Color</label>
              <input id="loginBgColor" type="color" class="mt-1 w-20 h-10 p-0 border rounded-md" />
              <div class="text-xs text-slate-500 mt-1">Updates the field on the left.</div>
            </div>
            <div class="flex items-end gap-2">
              <button id="saveLoginBg" class="btn btn-primary w-full">Save Login Background</button>
              <button id="resetLoginBg" class="btn w-full">Reset</button>
            </div>
          </div>
        </div>
      </section>

    </main>

    <nav class="bottom-nav md:hidden">
      <div class="flex items-center gap-2">
        <button class="bottom-btn active" data-tab="dashboard"><i class="ph ph-house"></i><span>Home</span></button>
        <button class="bottom-btn" data-tab="swap"><i class="ph ph-arrows-left-right"></i><span>Trade</span></button>
        <button class="bottom-btn" data-tab="positions"><i class="ph ph-list-bullets"></i><span>Positions</span></button>
        <button class="bottom-btn" data-tab="settings"><i class="ph ph-gear"></i><span>Settings</span></button>
      </div>
    </nav>
  </div>

  <!-- ASSET SEARCH MODAL -->
  <div id="assetModal" class="hidden modal">
    <div class="modal-bg" data-close-modal></div>
    <div class="modal-card">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2">
          <i class="ph ph-magnifying-glass text-slate-500"></i>
          <h3 class="font-semibold">Search Assets (CoinGecko)</h3>
        </div>
        <button class="btn" data-close-modal>Close</button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div class="md:col-span-2">
          <div class="flex items-center gap-2">
            <input id="assetSearchInput" class="input flex-1" placeholder="Search by name or symbol (e.g., 'doge', 'solana', 'bitcoin')" />
            <button id="assetSearchBtn" class="btn btn-primary"><i class="ph ph-magnifying-glass"></i><span class="ml-2 hidden sm:inline">Search</span></button>
          </div>
          <div id="assetResults" class="mt-3 max-h-80 overflow-auto divide-y divide-slate-200"></div>
        </div>

        <div>
          <div class="text-sm font-medium mb-2">Favorites</div>
          <div id="favoriteList" class="space-y-2 max-h-80 overflow-auto"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /***** CONFIG *****/
    const SECRET_SETTINGS_CODE = "admin123";
    let __AUTH_OK = false;

    // --- Git-backed Sync configuration ---
    // Fill these with your repo info. Use a *fine-grained* PAT scoped ONLY to this single repo with "Contents: Read & Write".
    // Example: OWNER: "TripleAxisCapital", REPO: "DEX-CB"
    const GH = {
      OWNER: "TripleAxisCapital",
      REPO:  "DEX-CB",
      BRANCH: "main",
      PATH:  "data/dex.sync.bin",
      TOKEN: "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" // leave empty to disable cloud sync
    };

    // Core assets
    const CORE_ASSETS = [
      { id: "bitcoin",       symbol: "BTC", name: "Bitcoin" },
      { id: "ethereum",      symbol: "ETH", name: "Ethereum" },
      { id: "solana",        symbol: "SOL", name: "Solana" },
      { id: "ripple",        symbol: "XRP", name: "XRP" },
      { id: "cardano",       symbol: "ADA", name: "Cardano" },
      { id: "binancecoin",   symbol: "BNB", name: "BNB" },
      { id: "polkadot",      symbol: "DOT", name: "Polkadot" },
      { id: "chainlink",     symbol: "LINK", name: "Chainlink" },
      { id: "uniswap",       symbol: "UNI", name: "Uniswap" },
      { id: "tron",          symbol: "TRX", name: "TRON" },
    ];

    const PRICE_POLL_MS = 10000;

    const K = {
      STATE: "dex_state_v1",
      HISTORY: "dex_history_v1",
      TRADES: "dex_trades_v1",
      EQUITY: "dex_equity_v1",
      FAVS: "dex_favorites_v1",
      UI: "dex_ui_v5",
      ORDERS: "dex_orders_v1",
      SEC: "dex_security_v1"
    };

    const defaultState = () => ({
      commissionPct: 0.30,
      holdings: {
        bitcoin: 0.25,
        ethereum: 5.0,
        solana: 100,
        ripple: 1500,
        cardano: 2000,
        binancecoin: 2,
        polkadot: 300,
        chainlink: 120,
        uniswap: 250,
        tron: 5000
      }
    });

    /***** UTIL *****/
    const $ = sel => document.querySelector(sel);
    const fmtUsd = n => n == null ? "—" : n.toLocaleString(undefined, { style: "currency", currency: "USD", maximumFractionDigits: 2 });
    const fmtPct = n => `${(n>=0?"+":"")}${n.toFixed(2)}%`;
    const clamp = (x,a,b) => Math.max(a, Math.min(b,x));
    const now = () => Date.now();
    const uid = () => (Date.now().toString(36)+Math.random().toString(36).slice(2,7)).toUpperCase();
    const enc = new TextEncoder(); const dec = new TextDecoder();

    const hexToRgb = (hex) => {
      const m = hex.replace('#','').match(/^([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i);
      if(!m) return {r:14,g:165,b:233};
      return { r: parseInt(m[1],16), g: parseInt(m[2],16), b: parseInt(m[3],16) };
    };
    const rgbToHex = (r,g,b)=>"#"+[r,g,b].map(x=>x.toString(16).padStart(2,"0")).join("");
    const darken = (hex, pct=20)=>{ const {r,g,b}=hexToRgb(hex); const f=(v)=>Math.max(0,Math.min(255,Math.round(v*(1-pct/100)))); return rgbToHex(f(r),f(g),f(b)); };

    const b64 = {
      fromBytes: (buf) => {
        let binary = ""; const bytes = new Uint8Array(buf);
        const len = bytes.byteLength;
        for (let i=0;i<len;i++) binary += String.fromCharCode(bytes[i]);
        return btoa(binary);
      },
      toBytes: (b64str) => {
        const binary = atob(b64str); const len = binary.length;
        const bytes = new Uint8Array(len);
        for (let i=0;i<len;i++) bytes[i] = binary.charCodeAt(i);
        return bytes;
      }
    };

    function loadState(){ const raw=localStorage.getItem(K.STATE); return raw?JSON.parse(raw):defaultState(); }
    function saveState(s){ localStorage.setItem(K.STATE, JSON.stringify(s)); onLocalChange(); }
    function loadHistory(){ const raw=localStorage.getItem(K.HISTORY); return raw?JSON.parse(raw):[]; }
    function saveHistory(h){ localStorage.setItem(K.HISTORY, JSON.stringify(h)); onLocalChange(); }
    function loadTrades(){ const raw=localStorage.getItem(K.TRADES); return raw?JSON.parse(raw):[]; }
    function saveTrades(t){ localStorage.setItem(K.TRADES, JSON.stringify(t)); onLocalChange(); }
    function loadEquity(){ const raw=localStorage.getItem(K.EQUITY); return raw?JSON.parse(raw):[]; }
    function saveEquity(e){ localStorage.setItem(K.EQUITY, JSON.stringify(e)); onLocalChange(); }
    function loadFavs(){ const raw=localStorage.getItem(K.FAVS); return raw?JSON.parse(raw):[]; }
    function saveFavs(arr){ localStorage.setItem(K.FAVS, JSON.stringify(arr)); onLocalChange(); }
    function loadUI(){ 
      const raw=localStorage.getItem(K.UI); 
      const defPad = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--app-x')) || 16;
      const base = { paddingPx: defPad, theme: "light", brandHex: "#0ea5e9", bootSeconds: 3.6, loginBg: null };
      return raw? { ...base, ...JSON.parse(raw) } : base;
    }
    function saveUI(u){ const cur = loadUI(); localStorage.setItem(K.UI, JSON.stringify({ ...cur, ...u })); onLocalChange(); }
    function loadOrders(){ const raw=localStorage.getItem(K.ORDERS); return raw?JSON.parse(raw):[]; }
    function saveOrders(o){ localStorage.setItem(K.ORDERS, JSON.stringify(o)); onLocalChange(); }

    function loadSec(){
      const raw = localStorage.getItem(K.SEC);
      if (raw) return JSON.parse(raw);
      return { account: "DCEBF009", password: "#ONYX5", key: "336664" };
    }
    function saveSec(s){ localStorage.setItem(K.SEC, JSON.stringify(s)); onLocalChange(); }

    function pushActivity(msg){
      const h=loadHistory(); h.unshift({t:now(),msg}); saveHistory(h.slice(0,200)); renderActivity();
    }
    function recordTrade(trade){
      const list = loadTrades(); list.unshift(trade); saveTrades(list.slice(0,500));
    }

    function recordEquityPoint(nlv, minGapMs=60_000){
      if (!isFinite(nlv)) return;
      const series = loadEquity();
      const last = series[0];
      const t = now();
      if (!last || (t - last.t) >= minGapMs || Math.abs((nlv - last.nlv)/Math.max(1,last.nlv)) > 0.002){
        series.unshift({ t, nlv: +nlv });
        saveEquity(series.slice(0,20_000));
      }
    }

    function getTradableAssets(){
      const favs = loadFavs();
      const map = new Map();
      CORE_ASSETS.forEach(a=>map.set(a.id,a));
      favs.forEach(a=>map.set(a.id,a));
      return Array.from(map.values());
    }
    const getSymbol = id => { const a = getTradableAssets().find(x=>x.id===id); return a?.symbol || id.toUpperCase(); };

    /***** GIT-BACKED SYNC *****/
    const Sync = (()=>{
      let derivedKey = null;
      let lastSha = null;
      let pauseSaves = false;
      let debounceId = 0;
      const enabled = ()=> !!(GH.TOKEN && GH.TOKEN !== "YOUR_FINEGRAINED_PAT_HERE" && GH.OWNER && GH.REPO && GH.PATH);

      function on(){ return { 
        auth: `Bearer ${GH.TOKEN}`,
        base: `https://api.github.com/repos/${GH.OWNER}/${GH.REPO}/contents/${encodeURIComponent(GH.PATH)}`
      };}

      async function derive(account, password, key, saltBytes){
        const material = enc.encode(`${account}:${password}:${key}`);
        const baseKey = await crypto.subtle.importKey("raw", material, "PBKDF2", false, ["deriveKey"]);
        return crypto.subtle.deriveKey(
          { name: "PBKDF2", salt: saltBytes, iterations: 200000, hash: "SHA-256" },
          baseKey,
          { name: "AES-GCM", length: 256 },
          false,
          ["encrypt","decrypt"]
        );
      }

      function gatherAll(){
        return {
          v: 1,
          ts: Date.now(),
          items: {
            [K.STATE]:    loadState(),
            [K.TRADES]:   loadTrades(),
            [K.HISTORY]:  loadHistory(),
            [K.EQUITY]:   loadEquity(),
            [K.FAVS]:     loadFavs(),
            [K.UI]:       loadUI(),
            [K.ORDERS]:   loadOrders(),
            [K.SEC]:      loadSec()
          }
        };
      }

      function applyAll(pkg){
        pauseSaves = true;
        try{
          if (pkg?.items){
            if (pkg.items[K.STATE]   != null) saveState(pkg.items[K.STATE]);
            if (pkg.items[K.TRADES]  != null) saveTrades(pkg.items[K.TRADES]);
            if (pkg.items[K.HISTORY] != null) saveHistory(pkg.items[K.HISTORY]);
            if (pkg.items[K.EQUITY]  != null) saveEquity(pkg.items[K.EQUITY]);
            if (pkg.items[K.FAVS]    != null) saveFavs(pkg.items[K.FAVS]);
            if (pkg.items[K.UI]      != null) saveUI(pkg.items[K.UI]);
            if (pkg.items[K.ORDERS]  != null) saveOrders(pkg.items[K.ORDERS]);
            if (pkg.items[K.SEC]     != null) saveSec(pkg.items[K.SEC]);
          }
        } finally { pauseSaves = false; }
      }

      async function encryptPackage(account, password, key){
        const salt = enc.encode(`DEX|${account}|v1`);
        derivedKey = await derive(account, password, key, salt);
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const data = enc.encode(JSON.stringify(gatherAll()));
        const ct = await crypto.subtle.encrypt({name:"AES-GCM", iv}, derivedKey, data);
        return {
          v: 1,
          algo: "AES-GCM",
          pbkdf2: { iters: 200000, hash: "SHA-256", salt_b64: b64.fromBytes(salt) },
          iv_b64: b64.fromBytes(iv),
          ct_b64: b64.fromBytes(ct),
          ts: Date.now()
        };
      }

      async function decryptPackage(blob, account, password, key){
        const salt = b64.toBytes(blob.pbkdf2?.salt_b64 || "");
        derivedKey = await derive(account, password, key, salt);
        const iv = b64.toBytes(blob.iv_b64);
        const ct = b64.toBytes(blob.ct_b64);
        const pt = await crypto.subtle.decrypt({name:"AES-GCM", iv}, derivedKey, ct);
        const obj = JSON.parse(dec.decode(new Uint8Array(pt)));
        return obj;
      }

      async function pull(account, password, key){
        if (!enabled()) return { ok:false, reason:"disabled" };
        const { auth, base } = on();
        const res = await fetch(base + `?ref=${encodeURIComponent(GH.BRANCH)}`, {
          headers: { "Authorization": auth, "Accept": "application/vnd.github+json" }
        });
        if (res.status === 404) { lastSha = null; return { ok:true, exist:false }; }
        if (!res.ok) { return { ok:false, reason:"fetch_failed" }; }
        const js = await res.json();
        lastSha = js.sha;
        const content = js.content || "";
        const text = atob(content.replace(/\n/g,""));
        const blob = JSON.parse(text);
        try{
          const pkg = await decryptPackage(blob, account, password, key);
          return { ok:true, exist:true, pkg };
        } catch(e){
          return { ok:false, reason:"decrypt_failed" };
        }
      }

      async function pushEncrypted(encryptedBlob){
        if (!enabled()) return { ok:false, reason:"disabled" };
        const { auth, base } = on();
        const contentB64 = btoa(JSON.stringify(encryptedBlob, null, 0));
        const body = {
          message: `sync: ${new Date().toISOString()}`,
          content: contentB64,
          branch: GH.BRANCH
        };
        if (lastSha) body.sha = lastSha;

        const res = await fetch(base, {
          method: "PUT",
          headers: {
            "Authorization": auth,
            "Accept": "application/vnd.github+json",
            "Content-Type": "application/json"
          },
          body: JSON.stringify(body)
        });
        if (!res.ok) return { ok:false, reason:"push_failed", status: res.status };
        const js = await res.json();
        lastSha = js.content?.sha || lastSha;
        return { ok:true };
      }

      async function initialOrUpdate(account, password, key){
        if (!enabled()) { appendLog("Sync • Skipped (disabled)."); return; }
        appendLog("Sync • Connecting to GitHub…");
        try{
          const result = await pull(account, password, key);
          if (result.ok && result.exist && result.pkg){
            appendLog("Sync • Decrypting cloud state…");
            applyAll(result.pkg);
            appendLog("Sync • Applied latest state from Git.");
          } else if (result.ok && !result.exist){
            appendLog("Sync • No cloud file. Seeding repo…");
            const encBlob = await encryptPackage(account, password, key);
            await pushEncrypted(encBlob);
            appendLog("Sync • Seeded encrypted state to Git.");
          } else if (result.reason === "decrypt_failed"){
            appendLog("Sync • Decryption failed (wrong credentials?). Using local.");
          } else {
            appendLog("Sync • Fetch failed. Using local.");
          }
        }catch(err){
          appendLog("Sync • Error: " + (err?.message||"unknown"));
        }
      }

      async function uploadNow(){
        if (!enabled() || pauseSaves || !derivedKey) return;
        try{
          const sec = loadSec();
          const encBlob = await encryptPackage(sec.account, sec.password, sec.key);
          await pushEncrypted(encBlob);
        } catch(e){ /* ignore transient errors */ }
      }
      function scheduleUpload(){
        if (!enabled() || pauseSaves || !derivedKey) return;
        clearTimeout(debounceId);
        debounceId = setTimeout(uploadNow, 1200);
      }
      return { enabled, initialOrUpdate, scheduleUpload };
    })();

    function onLocalChange(){ Sync.scheduleUpload(); }

    /***** AUTH *****/
    const loginOverlay = $("#loginOverlay");
    const loginForm = $("#loginForm");
    const loginLoading = $("#loginLoading");
    const bootLogsEl = $("#bootLogs");
    const progressBar = $("#progressBar");

    const DEFAULT_LOGIN_BG = "radial-gradient(1200px 600px at 20% -10%, #0ea5e933, transparent), radial-gradient(1200px 600px at 120% 110%, #06b6d433, transparent), linear-gradient(180deg,#0b1220, #0b1220)";
    function applyLoginBg(bg){ if (loginOverlay) loginOverlay.style.background = bg || DEFAULT_LOGIN_BG; }
    (function initLoginBg(){ const ui = loadUI(); applyLoginBg(ui.loginBg || DEFAULT_LOGIN_BG); })();

    ["loginAccount","loginPass","loginKey"].forEach(id=>{
      const el = ()=>document.getElementById(id);
      document.addEventListener("DOMContentLoaded", ()=>{ if(el()) el().value=""; });
      document.addEventListener("focus", ()=>{ if(el()) el().setAttribute("autocomplete","off"); }, true);
    });

    function appendLog(line){
      const el = document.createElement("div");
      el.textContent = `> ${line}`;
      bootLogsEl.appendChild(el);
      bootLogsEl.scrollTop = bootLogsEl.scrollHeight;
    }

    const BOOT_LINES = [
      "Verifying device posture",
      "Negotiating TLS 1.3 + ECDHE",
      "Establishing encrypted session",
      "Fetching market tickers",
      "Subscribing to order books",
      "Syncing positions & fills",
      "Applying risk & fee schedules",
      "Preparing trading interface"
    ];

    async function runBootSequence(){
      loginForm.classList.add("hidden");
      loginLoading.classList.remove("hidden");
      bootLogsEl.innerHTML = "";
      if (progressBar) progressBar.style.width = "0%";

      const totalSteps = BOOT_LINES.length;
      const totalMs = clamp(+loadUI().bootSeconds || 3.6, 0.5, 20) * 1000;
      const stepMs = Math.max(100, Math.floor(totalMs / totalSteps));
      let idx = 0;

      await new Promise(res=>{
        const intv = setInterval(()=>{
          appendLog(BOOT_LINES[idx] + "…");
          idx++;
          const pct = Math.round((idx/totalSteps)*100);
          if (progressBar) progressBar.style.width = pct + "%";
          if (idx >= totalSteps){
            clearInterval(intv);
            setTimeout(res, Math.min(400, Math.floor(stepMs * 0.4)));
          }
        }, stepMs);
      });
    }

    loginForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      try{
        const acct = document.getElementById("loginAccount").value.trim();
        const pass = document.getElementById("loginPass").value;
        const key  = document.getElementById("loginKey").value.trim();
        const sec = loadSec();

        const ok = (acct === sec.account && pass === sec.password && key === sec.key);
        if (ok) {
          $("#loginErr").classList.add("hidden");
          await runBootSequence();

          await Sync.initialOrUpdate(acct, pass, key);

          __AUTH_OK = true;
          loginOverlay.classList.add("hidden");
          ["loginAccount","loginPass","loginKey"].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=""; });
          boot();
        } else {
          $("#loginErr").classList.remove("hidden");
        }
      }catch(err){
        // If anything throws, show error visibly so it never "does nothing"
        $("#loginErr").textContent = "Login error: " + (err?.message || err || "unknown");
        $("#loginErr").classList.remove("hidden");
        loginForm.classList.remove("hidden");
        loginLoading.classList.add("hidden");
      }
    });
    const loginBtn = document.getElementById('loginBtn');
    if (loginBtn) loginBtn.addEventListener('click', (ev)=>{ ev.preventDefault(); if (loginForm) loginForm.requestSubmit(); });

    /***** NAV *****/
    function showPage(id){
      const pages = ["dashboard","swap","positions","settings"];
      pages.forEach(p=>$("#page-"+p).classList.toggle("hidden", p!==id));
      document.querySelectorAll(".bottom-btn").forEach(b=>b.classList.toggle("active", b.dataset.tab===id));
      document.querySelectorAll(".top-btn").forEach(b=>b.classList.toggle("active", b.dataset.tab===id));
      window.scrollTo({top:0, behavior:'smooth'});
    }
    $("#logoutBtn")?.addEventListener("click", ()=>{
      __AUTH_OK = false;
      location.reload();
    });
    document.querySelectorAll(".bottom-btn").forEach(btn=>btn.addEventListener("click", ()=>showPage(btn.dataset.tab)));
    document.querySelectorAll(".top-btn").forEach(btn=>btn.addEventListener("click", ()=>showPage(btn.dataset.tab)));
    $("#openAssetSearchMobile")?.addEventListener("click", ()=>openAssetModal());
    $("#openAssetSearch")?.addEventListener("click", ()=>openAssetModal());

    /***** MARKET DATA *****/
    let market = {}; let lastUpdated = 0;
    async function fetchMarket() {
      const tradables = getTradableAssets();
      if (tradables.length === 0) return;
      const ids = tradables.map(a=>a.id).join(",");
      const url = `https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=${ids}&price_change_percentage=24h`;
      const res = await fetch(url, { headers: { "accept": "application/json" }});
      if (!res.ok) throw new Error("Market API error");
      const data = await res.json();
      const out = {};
      data.forEach(row => { out[row.id] = { price: +row.current_price, chg24: row.price_change_percentage_24h_in_currency ?? row.price_change_percentage_24h ?? 0, image: row.image }; });
      market = out;
      lastUpdated = now();
      updateUI(true);
      processOrders();
    }
    const priceOf = id => market[id]?.price ?? null;
    const imageOf = id => market[id]?.image ?? "";

    function priceCPB(currencyId, buyId){
      const c = priceOf(currencyId), b = priceOf(buyId);
      if (c==null || b==null) return null;
      return b / c;
    }
    function commissionPct(){ return clamp(loadState().commissionPct, 0, 100); }
    function calcFromForBuyQty(buyQty, px, feePct){
      const gross = buyQty * px;
      const fromAmt = gross / (1 - feePct/100);
      return { fromAmt, gross, feeAmt: fromAmt - gross };
    }
    function executeBuyAtPrice(state, currencyId, buyId, buyQty, px){
      const feePct = commissionPct();
      const { fromAmt } = calcFromForBuyQty(buyQty, px, feePct);
      if ((state.holdings[currencyId]||0) < fromAmt) return { ok:false, msg:"Insufficient balance." };
      state.holdings[currencyId] -= fromAmt;
      state.holdings[buyId] = (state.holdings[buyId]||0) + buyQty;
      return { ok:true, fromAmt, feePct, px };
    }

    function calcNLV(state){
      let total = 0;
      for (const a of getTradableAssets()){
        const px = priceOf(a.id);
        if (px!=null) total += (state.holdings[a.id]||0) * px;
      }
      return total;
    }

    /***** CHART *****/
    let chart; let currentRange = "7D";
    function makeBrandGradient(ctx){
      const g = ctx.createLinearGradient(0,0,0,260);
      const rgb = getComputedStyle(document.documentElement).getPropertyValue("--brand").trim() || "#0ea5e9";
      const {r,g:gg,b} = hexToRgb(rgb);
      g.addColorStop(0, `rgba(${r},${gg},${b},0.35)`);
      g.addColorStop(1, `rgba(${r},${gg},${b},0.02)`);
      return g;
    }
    function initChart(){
      const canvas = $("#nlvChart");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      chart = new Chart(ctx, {
        type: "line",
        data: { labels: [], datasets: [{ label: "Portfolio", data: [], tension: 0.3, borderWidth: 2, pointRadius: 0, borderColor: getComputedStyle(document.documentElement).getPropertyValue("--brand").trim() || "#0ea5e9", fill: true, backgroundColor: makeBrandGradient(ctx) }] },
        options: {
          responsive:true, maintainAspectRatio:false, animation:false,
          plugins:{ legend:{display:false}, tooltip:{mode:'index',intersect:false, callbacks:{ label: ctx => fmtUsd(ctx.parsed.y) }}},
          scales:{ x:{ display:true, ticks:{ maxTicksLimit:6 }}, y:{ ticks:{ callback:v=>"$"+(v/1000).toFixed(0)+"k" } } }
        }
      });
      refreshChart();
    }
    function refreshChart(){
      if (!chart) return;
      const series = loadEquity();
      const ranges = { "7D":7*24*3600e3, "1M":30*24*3600e3, "3M":90*24*3600e3, "1Y":365*24*3600e3, "ALL":Infinity };
      const cutoff = isFinite(ranges[currentRange]) ? (now() - ranges[currentRange]) : -Infinity;
      const filtered = series.filter(p => p.t >= cutoff).slice().reverse();
      const data = filtered.length<=300 ? filtered : filtered.filter((_,i)=>i%Math.ceil(filtered.length/300)===0);

      chart.data.labels = data.map(p => {
        const d=new Date(p.t);
        return (currentRange==="7D"||currentRange==="1M")
          ? (d.toLocaleDateString(undefined,{month:"short", day:"numeric"})+" "+d.toLocaleTimeString(undefined,{hour:"2-digit",minute:"2-digit"}))
          : d.toLocaleDateString(undefined,{year:"2-digit",month:"short", day:"numeric"});
      });
      chart.data.datasets[0].data = data.map(p => ({x:p.t, y:p.nlv}));
      chart.update("none");

      const first = data[0]?.nlv, last = data[data.length-1]?.nlv;
      const el = $("#rangeChange");
      if (first && last){
        const pct = (last-first)/first*100;
        el.textContent = fmtPct(pct);
        el.classList.toggle("green", pct>=0);
        el.classList.toggle("red", pct<0);
      } else { el.textContent = "—"; el.classList.remove("green","red"); }
    }
    function pushChartPoint(nlv){ recordEquityPoint(nlv); refreshChart(); }
    document.addEventListener("click", (e)=>{
      const tab = e.target.closest(".pill-tab"); if (!tab) return;
      document.querySelectorAll(".pill-tab").forEach(b=>b.classList.remove("active"));
      tab.classList.add("active"); currentRange = tab.dataset.range; refreshChart();
    });

    function autoFitNLV(){
      const el = $("#nlvValue");
      if (!el) return;
      const max = 32; const min = 14;
      el.style.fontSize = max + "px";
      let size = max;
      while (el.scrollWidth > el.clientWidth && size > min){
        size -= 1;
        el.style.fontSize = size + "px";
      }
    }
    window.addEventListener("resize", ()=>{ autoFitNLV(); });

    /***** RENDER *****/
    function populateSelects(){
      const opts = getTradableAssets().map(a => `<option value="${a.id}">${a.symbol} • ${a.name}</option>`).join("");
      ["qsFrom","qsTo","payCurrency","buyAsset"].forEach(id => { const el=$("#"+id); if (el) el.innerHTML = opts; });
      if ($("#qsFrom") && !$("#qsFrom").value){ $("#qsFrom").value="bitcoin"; }
      if ($("#qsTo") && !$("#qsTo").value){ $("#qsTo").value="ethereum"; }
      if ($("#payCurrency") && !$("#payCurrency").value){ $("#payCurrency").value="bitcoin"; }
      if ($("#buyAsset") && !$("#buyAsset").value){ $("#buyAsset").value="ethereum"; }
    }
    function renderHeader(nlv){
      $("#headerNLV").textContent = fmtUsd(nlv);
      $("#headerNLV").classList.remove("hidden");
      $("#lastUpdated").textContent = lastUpdated ? new Date(lastUpdated).toLocaleTimeString() : "—";
    }
    function renderSummary(state){
      const nlv = calcNLV(state);
      const el = $("#nlvValue");
      if (el) { el.textContent = fmtUsd(nlv); requestAnimationFrame(autoFitNLV); }
      const series = loadEquity();
      const prev = series[1]?.nlv;
      const delta = prev!=null ? ((nlv - prev)/prev)*100 : 0;
      const dEl = $("#nlvDelta");
      dEl.textContent = (prev==null) ? "—" : fmtPct(delta);
      dEl.classList.toggle("green", delta>=0);
      dEl.classList.toggle("red", delta<0);
      renderHeader(nlv);

      const rows = getTradableAssets().map(a => {
        const px = priceOf(a.id)??0, qty = loadState().holdings[a.id]??0, v=px*qty;
        return { id:a.id, symbol:a.symbol, v };
      }).sort((x,y)=>y.v-x.v);
      const total = nlv || 1;
      const top = rows[0];
      $("#topWeight").textContent = top ? `${top.symbol} • ${(top.v/total*100).toFixed(2)}%` : "—";
    }
    function isFav(id){ return loadFavs().some(f=>f.id===id); }

    function renderPositions(state){
      const list = $("#positionsList");
      if (!list) return;
      list.innerHTML = "";
      const nlv = calcNLV(state) || 1;

      for (const a of getTradableAssets()){
        const qty = state.holdings[a.id]||0;
        const px = priceOf(a.id);
        const v = (px!=null) ? qty*px : 0;
        const weight = (v/nlv)*100;
        const chg = market[a.id]?.chg24 ?? 0;

        const row = document.createElement("div");
        row.className = "pos-row";

        row.innerHTML = `
          <div class="flex items-center gap-3">
            <img src="${imageOf(a.id) || 'https://cryptoicons.org/api/icon/btc/32'}" alt="${a.symbol}" class="w-8 h-8 rounded-lg border border-slate-200"/>
            <div class="flex-1">
              <div class="font-medium">${a.symbol}</div>
              <div class="text-xs text-slate-500">${a.name}</div>
            </div>
            <button class="chip whitespace-nowrap" data-toggle-fav="${a.id}">
              <i class="ph ${isFav(a.id)?'ph-star':'ph-star-four'}"></i>
              <span>${isFav(a.id)?'Favorited':'Favorite'}</span>
            </button>
          </div>

          <div class="flex items-baseline justify-between md:block">
            <div class="font-medium">${px!=null?fmtUsd(px):"—"}</div>
            <div class="text-xs ${chg>=0?"green":"red"} md:mt-1">${fmtPct(chg)}</div>
          </div>

          <div><div class="font-medium">${qty.toFixed(6)}</div><div class="text-xs text-slate-500 md:mt-1">Holding</div></div>
          <div><div class="font-medium">${fmtUsd(v)}</div><div class="text-xs text-slate-500 md:mt-1">Value</div></div>
          <div class="md:text-right"><div class="font-medium">${weight.toFixed(2)}%</div><div class="text-xs text-slate-500 md:mt-1">Weight</div></div>
        `;
        list.appendChild(row);
      }
      list.querySelectorAll("[data-toggle-fav]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-toggle-fav");
          toggleFavoriteById(id);
        });
      });
    }

    function renderActivity(){
      const list = $("#activityList");
      if (!list) return;
      const h = loadHistory();
      const trades = loadTrades();
      const allowed = /^(SWAP|ORDER|FILL|MARKET BUY|TRIGGER|TRAIL)/i;

      const tradeBlocks = trades.slice(0,30).map(tr=>{
        const d = new Date(tr.t).toLocaleString();
        return `<div class="flex items-center justify-between">
          <div><span class="font-medium">TRADE</span>
          • ${tr.fromAmt} ${getSymbol(tr.fromId)} → ${tr.toAmt} ${getSymbol(tr.toId)}
          <span class="text-slate-500"> (fee ${tr.feePct.toFixed(2)}%, price ${tr.rate})</span></div>
          <div class="text-xs text-slate-500">${d}</div></div>`;
      }).join("");

      const actBlocks = h.filter(e=>allowed.test(e.msg)).slice(0,50).map(e=>{
        const d = new Date(e.t).toLocaleString();
        return `<div class="flex items-center justify-between"><div>${e.msg}</div><div class="text-xs text-slate-500">${d}</div></div>`;
      }).join("");

      list.innerHTML = `
        <div class="text-xs uppercase tracking-wider text-slate-500 mb-1">Trades</div>
        <div class="space-y-2 mb-4">${tradeBlocks || '<div class="text-slate-500">No trades yet.</div>'}</div>
        <div class="text-xs uppercase tracking-wider text-slate-500 mb-1">System</div>
        <div class="space-y-2">${actBlocks || '<div class="text-slate-500">No activity yet.</div>'}</div>
      `;
    }

    /***** QUICK SWAP *****/
    function marketRate(fromId, toId){
      const fp = priceOf(fromId), tp = priceOf(toId);
      if (fp==null || tp==null) return null;
      return fp / tp;
    }

    function quoteSwap(state, fromId, toId, fromAmt){
      const fromPx = priceOf(fromId), toPx = priceOf(toId);
      if (fromId===toId) return { ok:false, msg:"Select different assets." };
      if (fromPx==null || toPx==null) return { ok:false, msg:"No market price." };
      if (!(fromAmt>0)) return { ok:false, msg:"Enter an amount." };
      if ((state.holdings[fromId]||0) < fromAmt) return { ok:false, msg:"Insufficient balance." };
      const feePct = commissionPct();
      const effectiveFrom = fromAmt * (1 - feePct/100.0);
      const usdValue = effectiveFrom * fromPx;
      const toAmt = usdValue / toPx;
      return { ok:true, toAmt, feePct, usdValue, fromPx, toPx };
    }
    function doSwap(state, fromId, toId, fromAmt){
      const q = quoteSwap(state, fromId, toId, fromAmt);
      if (!q.ok) return q;
      state.holdings[fromId] -= fromAmt;
      state.holdings[toId] += q.toAmt;
      return { ok:true, ...q };
    }

    let lastEdited = "FROM";
    function updateQuickQuote(){
      const s = loadState();
      const from = $("#qsFrom")?.value, to = $("#qsTo")?.value;
      if (!from || !to) return;
      const r = marketRate(from,to);
      const fee = commissionPct();
      const el = $("#qsQuote");
      if (!el) return;
      if (!r){ el.textContent = "No market price."; return; }

      let needFrom = +($("#qsAmtFrom")?.value || 0);
      let wantTo   = +($("#qsAmtTo")?.value   || 0);

      if (lastEdited === "FROM"){
        if (!(needFrom>0)){ el.textContent = "Enter an amount."; if($("#qsAmtTo")) $("#qsAmtTo").value=""; return; }
        if ((s.holdings[from]||0) < needFrom){ el.textContent = "Insufficient balance."; return; }
        const getTo = (needFrom * (1 - fee/100)) * r;
        if ($("#qsAmtTo")) $("#qsAmtTo").value = getTo ? getTo.toFixed(6) : "";
        el.textContent = `Rate: 1 ${getSymbol(from)} = ${r.toFixed(6)} ${getSymbol(to)} • Fee ${fee.toFixed(2)}% • Receive ≈ ${getTo.toFixed(6)} ${getSymbol(to)}`;
      } else {
        if (!(wantTo>0)){ el.textContent = "Enter an amount."; if($("#qsAmtFrom")) $("#qsAmtFrom").value=""; return; }
        const needFromCalc = wantTo / r / (1 - fee/100);
        if ($("#qsAmtFrom")) $("#qsAmtFrom").value = needFromCalc ? needFromCalc.toFixed(6) : "";
        if ((s.holdings[from]||0) < needFromCalc){ el.textContent = "Insufficient balance."; return; }
        el.textContent = `Rate: 1 ${getSymbol(from)} = ${r.toFixed(6)} ${getSymbol(to)} • Fee ${fee.toFixed(2)}% • Need ≈ ${needFromCalc.toFixed(6)} ${getSymbol(from)}`;
      }
    }

    $("#qsFrom")?.addEventListener("change", updateQuickQuote);
    $("#qsTo")?.addEventListener("change", updateQuickQuote);
    $("#qsAmtFrom")?.addEventListener("input", ()=>{ lastEdited="FROM"; updateQuickQuote(); });
    $("#qsAmtTo")?.addEventListener("input", ()=>{ lastEdited="TO"; updateQuickQuote(); });

    $("#qsSwap")?.addEventListener("click", ()=>{
      const s = loadState();
      const from = $("#qsFrom").value, to = $("#qsTo").value;
      const fromAmt = +$("#qsAmtFrom").value;
      if (!(fromAmt>0)){ $("#qsMsg").textContent = "Enter an amount."; return; }
      const res = doSwap(s, from, to, fromAmt);
      const msg = $("#qsMsg");
      if (res.ok){
        saveState(s);
        const trade = { t: now(), fromId: from, toId: to, fromAmt: +fromAmt, toAmt: +res.toAmt.toFixed(6), feePct: +res.feePct, rate: +(res.fromPx/res.toPx).toFixed(6) };
        recordTrade(trade);
        pushActivity(`SWAP • ${fromAmt} ${getSymbol(from)} → ${res.toAmt.toFixed(6)} ${getSymbol(to)} (fee ${res.feePct.toFixed(2)}%)`);
        updateUI(true);
        msg.textContent = "Swap executed.";
        $("#qsAmtFrom").value = ""; $("#qsAmtTo").value = "";
        updateQuickQuote();
      } else msg.textContent = res.msg;
    });

    /***** TRADING TICKET *****/
    let swOrderType = "MARKET";
    function setOrderType(t){
      swOrderType = t;
      ["ordTypeMarket","ordTypeLimit","ordTypeStop","ordTypeTrail"].forEach(id=>{
        const btn = $("#"+id); if(!btn) return;
        const val = btn.dataset.ordtype;
        btn.classList.toggle("active", val===t);
      });
      $("#limitWrap").classList.toggle("hidden", t!=="LIMIT");
      $("#stopWrap").classList.toggle("hidden", t!=="STOP");
      $("#trailWrap").classList.toggle("hidden", t!=="TRAIL");
      const execSel = $("#stopExec");
      if (execSel) $("#stopLimitCell").classList.toggle("hidden", !(t==="STOP" && execSel.value==="LIMIT"));
      updateTradeQuote();
    }
    $("#ordTypeMarket").addEventListener("click", ()=>setOrderType("MARKET"));
    $("#ordTypeLimit").addEventListener("click", ()=>setOrderType("LIMIT"));
    $("#ordTypeStop").addEventListener("click", ()=>setOrderType("STOP"));
    $("#ordTypeTrail").addEventListener("click", ()=>setOrderType("TRAIL"));
    $("#stopExec").addEventListener("change", ()=>{
      $("#stopLimitCell").classList.toggle("hidden", $("#stopExec").value!=="LIMIT");
      updateTradeQuote();
    });

    ["payCurrency","buyAsset","buyQty","limitPriceBuy","tif","stopPriceBuy","stopSide","stopLimitPriceBuy","trailType","trailValue","trailActivation"].forEach(id=>{
      const el = document.getElementById(id);
      if (el) el.addEventListener("input", updateTradeQuote);
      if (el) el.addEventListener("change", updateTradeQuote);
    });

    function updateTradeQuote(){
      const cur = $("#payCurrency")?.value, buy = $("#buyAsset")?.value;
      const qty = +($("#buyQty")?.value || 0);
      const fee = commissionPct();
      const s = loadState();
      const el = $("#swQuote");
      if (!el) return;
      if (!cur || !buy || cur===buy){ el.textContent = "Choose different assets."; return; }
      const mkt = priceCPB(cur,buy);
      if (!mkt){ el.textContent = "No market price."; return; }

      function needText(px){
        const { fromAmt } = calcFromForBuyQty(qty, px, fee);
        const bal = s.holdings[cur]||0;
        const ok = bal >= fromAmt;
        return `Price ${px.toFixed(6)} ${getSymbol(cur)}/1 ${getSymbol(buy)} • Need ${fromAmt.toFixed(6)} ${getSymbol(cur)} • ${ok?"Balance OK":"Insufficient ("+bal.toFixed(6)+")"}`;
      }

      if (!(qty>0)){ el.textContent = "Enter a quantity to buy."; return; }

      if (swOrderType==="MARKET"){ el.textContent = `Market • ${needText(mkt)}`; return; }
      if (swOrderType==="LIMIT"){
        const L = +$("#limitPriceBuy").value || 0;
        if (!(L>0)){ el.textContent = "Enter a limit price."; return; }
        const cond = mkt <= L ? "fillable now" : `waiting ≤ ${L}`;
        el.textContent = `Limit • ${needText(L)} • ${cond}`; return;
      }
      if (swOrderType==="STOP"){
        const S = +$("#stopPriceBuy").value || 0;
        const dir = $("#stopSide").value || "ABOVE";
        if (!(S>0)){ el.textContent = "Enter a stop trigger."; return; }
        const trig = dir==="ABOVE" ? `triggers when ≥ ${S}` : `triggers when ≤ ${S}`;
        if ($("#stopExec").value==="LIMIT"){
          const SL = +$("#stopLimitPriceBuy").value || 0;
          if (!(SL>0)) { el.textContent = "Enter stop & limit price."; return; }
          el.textContent = `Stop-Limit • ${trig}, then place Limit @ ${SL} • ${needText(SL)}`;
        } else { el.textContent = `Stop-Market • ${trig} • est ${needText(S)}`; }
        return;
      }
      if (swOrderType==="TRAIL"){
        const tType = $("#trailType").value || "PCT";
        const tVal = +$("#trailValue").value || 0;
        const act = +($("#trailActivation").value || 0) || null;
        if (!(tVal>0)){ el.textContent = "Enter a trail value."; return; }
        const label = tType==="PCT" ? `${tVal}%` : `${tVal} ${getSymbol(cur)}`;
        el.textContent = `Trailing (buy) • trails the low by ${label}${isFinite(act)?`, activates ≤ ${act}`:""} • Current need (mkt): ${needText(mkt)}`;
      }
    }

    $("#placeOrderBtn").addEventListener("click", ()=>{
      const cur = $("#payCurrency").value, buy = $("#buyAsset").value;
      const qty = +($("#buyQty").value || 0);
      const s = loadState();
      const mkt = priceCPB(cur,buy);
      const msg = $("#swMsg"); msg.textContent = "";
      if (!cur || !buy || cur===buy){ msg.textContent = "Choose different assets."; return; }
      if (!(qty>0)){ msg.textContent = "Enter a quantity to buy."; return; }
      if (!mkt){ msg.textContent = "No market price."; return; }

      if (swOrderType==="MARKET"){
        const res = executeBuyAtPrice(s, cur, buy, qty, mkt);
        if (res.ok){
          saveState(s);
          const trade = { t: now(), fromId: cur, toId: buy, fromAmt: +res.fromAmt.toFixed(6), toAmt: +qty.toFixed(6), feePct: +commissionPct(), rate: +mkt.toFixed(6) };
          recordTrade(trade);
          pushActivity(`MARKET BUY • ${qty} ${getSymbol(buy)} using ${trade.fromAmt} ${getSymbol(cur)} @ ${mkt.toFixed(6)}`);
          updateUI(true);
          msg.textContent = "Order filled.";
          $("#buyQty").value="";
          updateTradeQuote();
        } else { msg.textContent = res.msg; }
        return;
      }

      if (swOrderType==="LIMIT"){
        const L = +$("#limitPriceBuy").value || 0;
        const tif = $("#tif").value || "GTC";
        if (!(L>0)){ msg.textContent = "Enter a limit price."; return; }
        if (mkt <= L){
          const res = executeBuyAtPrice(s, cur, buy, qty, L);
          if (res.ok){
            saveState(s);
            const trade = { t: now(), fromId: cur, toId: buy, fromAmt: +res.fromAmt.toFixed(6), toAmt: +qty.toFixed(6), feePct: +commissionPct(), rate: +L.toFixed(6) };
            recordTrade(trade);
            pushActivity(`FILL • LIMIT BUY @ ${L} (${qty} ${getSymbol(buy)})`);
            updateUI(true);
            msg.textContent = "Limit filled immediately.";
            $("#buyQty").value="";
            updateTradeQuote();
            return;
          }
        }
        const order = { id: uid(), t: now(), type: "LIMIT", tif, currencyId: cur, buyId: buy, buyQty: qty, limitPrice: L, status: "OPEN" };
        const orders = loadOrders(); orders.unshift(order); saveOrders(orders);
        pushActivity(`ORDER • LIMIT BUY ${qty} ${getSymbol(buy)} @ ${L} ${getSymbol(cur)}/${getSymbol(buy)} (${tif})`);
        renderOpenOrders();
        msg.textContent = "Limit order placed."; updateTradeQuote(); processOrders(); return;
      }

      if (swOrderType==="STOP"){
        const S = +$("#stopPriceBuy").value || 0;
        const dir = $("#stopSide").value || "ABOVE";
        const exec = $("#stopExec").value || "MARKET";
        const SL = +($("#stopLimitPriceBuy").value || 0);
        if (!(S>0)){ msg.textContent = "Enter a stop trigger."; return; }
        if (exec==="LIMIT" && !(SL>0)){ msg.textContent = "Enter stop & limit price."; return; }
        const order = { id: uid(), t: now(), type: "STOP", status:"OPEN", currencyId: cur, buyId: buy, buyQty: qty, stopPrice: S, stopSide: dir, onTrigger: exec, limitPrice: exec==="LIMIT" ? SL : null, triggered: false };
        const orders = loadOrders(); orders.unshift(order); saveOrders(orders);
        pushActivity(`ORDER • STOP BUY ${dir} ${S} ${exec==="LIMIT" ? "→ LIMIT @ "+SL : "→ MARKET"}`);
        renderOpenOrders();
        msg.textContent = "Stop order placed."; updateTradeQuote(); processOrders(); return;
      }

      if (swOrderType==="TRAIL"){
        const tType = $("#trailType").value || "PCT";
        const tVal = +$("#trailValue").value || 0;
        const act = +($("#trailActivation").value || 0) || null;
        if (!(tVal>0)){ msg.textContent = "Enter a trail value."; return; }
        const order = { id: uid(), t: now(), type: "TRAIL", status:"OPEN", currencyId: cur, buyId: buy, buyQty: qty, trailType: tType, trailValue: tVal, activationPrice: isFinite(act) ? act : null, activated: isFinite(act) ? false : true, peg: priceCPB(cur,buy) };
        const orders = loadOrders(); orders.unshift(order); saveOrders(orders);
        pushActivity(`ORDER • TRAILING BUY by ${tType==="PCT"? tVal+"%": tVal+" "+getSymbol(cur)}${order.activationPrice? " (activates ≤ "+order.activationPrice+")":""}`);
        renderOpenOrders();
        msg.textContent = "Trailing order placed."; updateTradeQuote(); processOrders();
      }
    });

    function renderOpenOrders(){
      const box = $("#openOrders");
      const orders = loadOrders().filter(o=>o.status==="OPEN");
      if (!box) return;
      if (!orders.length){ box.innerHTML = `<div class="text-slate-500">No open orders.</div>`; return; }
      box.innerHTML = orders.map(o=>{
        const pair = `${getSymbol(o.buyId)}/${getSymbol(o.currencyId)}`;
        let desc = "";
        if (o.type==="LIMIT") desc = `LIMIT @ ${(+o.limitPrice).toFixed(6)} ${getSymbol(o.currencyId)}/1 ${getSymbol(o.buyId)} • ${o.buyQty} ${getSymbol(o.buyId)}`;
        if (o.type==="STOP")  desc = `STOP ${o.stopSide} ${(+o.stopPrice).toFixed(6)} ${o.onTrigger==="LIMIT"?"→ LIMIT @ "+(+o.limitPrice).toFixed(6):"→ MARKET"} • ${o.buyQty} ${getSymbol(o.buyId)}`;
        if (o.type==="TRAIL") desc = `TRAIL ${o.trailType==="PCT"?o.trailValue+"%":o.trailValue+" "+getSymbol(o.currencyId)}${o.activationPrice? " • activates ≤ "+o.activationPrice:""} • ${o.buyQty} ${getSymbol(o.buyId)}`;
        return `
        <div class="flex items-center justify-between p-2 rounded-lg border border-slate-200" style="background: var(--surface);">
          <div class="flex flex-col"><div class="font-medium">Buy ${pair}</div><div class="text-xs text-slate-600">${o.type} • ${desc}</div></div>
          <div class="flex items-center gap-3"><button class="btn" data-cancel="${o.id}"><i class="ph ph-x"></i></button></div>
        </div>`;
      }).join("");
      box.querySelectorAll("[data-cancel]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.getAttribute("data-cancel");
          const orders = loadOrders();
          const idx = orders.findIndex(x=>x.id===id);
          if (idx>=0){ orders[idx].status="CANCELLED"; saveOrders(orders); renderOpenOrders(); pushActivity(`ORDER • Cancelled ${id}`); }
        });
      });
    }

    function processOrders(){
      const s = loadState();
      let orders = loadOrders();
      let changed = false;

      for (const o of orders){
        if (o.status!=="OPEN") continue;
        const mkt = priceCPB(o.currencyId, o.buyId);
        if (!mkt) continue;
        const needAt = (px)=> calcFromForBuyQty(o.buyQty, px, commissionPct()).fromAmt;

        if (o.type==="LIMIT"){
          if (mkt <= o.limitPrice){
            const fromAmt = needAt(o.limitPrice);
            const bal = s.holdings[o.currencyId]||0;
            if (bal >= fromAmt){
              const res = executeBuyAtPrice(s, o.currencyId, o.buyId, o.buyQty, o.limitPrice);
              if (res.ok){
                saveState(s);
                const trade = { t: now(), fromId: o.currencyId, toId: o.buyId, fromAmt: +res.fromAmt.toFixed(6), toAmt: +o.buyQty.toFixed(6), feePct: +commissionPct(), rate: +o.limitPrice.toFixed(6) };
                recordTrade(trade);
                pushActivity(`FILL • LIMIT BUY @ ${o.limitPrice} (${o.buyQty} ${getSymbol(o.buyId)})`);
                o.status="FILLED"; changed=true;
              }
            } else if (o.tif==="IOC"){
              o.status="CANCELLED"; changed=true; pushActivity(`ORDER • IOC cancelled ${o.id} (insufficient)`);
            }
          }
          continue;
        }

        if (o.type==="STOP"){
          const trig = (o.stopSide==="ABOVE") ? (mkt >= o.stopPrice) : (mkt <= o.stopPrice);
          if (!trig) continue;
          if (o.onTrigger==="MARKET"){
            const fromAmt = needAt(mkt);
            if ((s.holdings[o.currencyId]||0) >= fromAmt){
              const res = executeBuyAtPrice(s, o.currencyId, o.buyId, o.buyQty, mkt);
              if (res.ok){
                saveState(s);
                const trade = { t: now(), fromId: o.currencyId, toId: o.buyId, fromAmt: +res.fromAmt.toFixed(6), toAmt: +o.buyQty.toFixed(6), feePct: +commissionPct(), rate: +mkt.toFixed(6) };
                recordTrade(trade);
                pushActivity(`FILL • STOP-MARKET BUY @ ${mkt.toFixed(6)} (trigger ${o.stopSide} ${o.stopPrice})`);
                o.status="FILLED"; changed=true;
              }
            }
          } else {
            if (mkt <= o.limitPrice){
              const fromAmt = needAt(o.limitPrice);
              if ((s.holdings[o.currencyId]||0) >= fromAmt){
                const res = executeBuyAtPrice(s, o.currencyId, o.buyId, o.buyQty, o.limitPrice);
                if (res.ok){
                  saveState(s);
                  const trade = { t: now(), fromId: o.currencyId, toId: o.buyId, fromAmt: +res.fromAmt.toFixed(6), toAmt: +o.buyQty.toFixed(6), feePct: +commissionPct(), rate: +o.limitPrice.toFixed(6) };
                  recordTrade(trade);
                  pushActivity(`FILL • STOP-LIMIT BUY @ ${o.limitPrice} (trigger ${o.stopSide} ${o.stopPrice})`);
                  o.status="FILLED"; changed=true;
                }
              }
            } else {
              if (!o.triggered){
                o.type="LIMIT"; o.tif="GTC"; o.triggered=true;
                pushActivity(`TRIGGER • STOP → LIMIT @ ${o.limitPrice}`);
                changed=true;
              }
            }
          }
          continue;
        }

        if (o.type==="TRAIL"){
          if (o.activationPrice!=null && !o.activated){
            if (mkt <= o.activationPrice){ o.activated = true; o.peg = mkt; pushActivity(`TRAIL • Activated @ ${mkt.toFixed(6)}`); changed=true; }
            continue;
          }
          o.peg = Math.min(o.peg, mkt);
          let trig = false;
          if (o.trailType==="PCT") trig = mkt >= o.peg * (1 + o.trailValue/100);
          else trig = mkt >= o.peg + o.trailValue;
          if (trig){
            const fromAmt = needAt(mkt);
            if ((s.holdings[o.currencyId]||0) >= fromAmt){
              const res = executeBuyAtPrice(s, o.currencyId, o.buyId, o.buyQty, mkt);
              if (res.ok){
                saveState(s);
                const trade = { t: now(), fromId: o.currencyId, toId: o.buyId, fromAmt: +res.fromAmt.toFixed(6), toAmt: +o.buyQty.toFixed(6), feePct: +commissionPct(), rate: +mkt.toFixed(6) };
                recordTrade(trade);
                pushActivity(`FILL • TRAILING BUY @ ${mkt.toFixed(6)} (peg ${o.peg.toFixed(6)})`);
                o.status="FILLED"; changed=true;
              }
            }
          }
          continue;
        }
      }
      if (changed){ saveOrders(orders); renderOpenOrders(); updateUI(true); }
    }

    /***** ADVANCED *****/
    const advWrap = $("#advancedWrap");
    const lockBtn = $("#lockBtn");
    $("#unlockBtn").addEventListener("click", ()=>{
      const code = prompt("Enter access code:");
      if (code === SECRET_SETTINGS_CODE){
        $("#lockedNote").classList.add("hidden");
        advWrap.classList.remove("hidden");
        lockBtn.classList.remove("hidden");
        loadAdvancedEditor();
        renderAdminDebug();
        const ui = loadUI();
        const bs = $("#bootSeconds"); const bsv = $("#bootSecondsVal");
        if (bs){ bs.value = ui.bootSeconds ?? 3.6; if (bsv) bsv.textContent = (ui.bootSeconds ?? 3.6) + "s"; }
      } else alert("Incorrect code.");
    });
    lockBtn.addEventListener("click", ()=>{
      advWrap.classList.add("hidden");
      lockBtn.classList.add("hidden");
      $("#lockedNote").classList.remove("hidden");
    });

    function loadAdvancedEditor(){
      const s = loadState();
      const advCommission = $("#advCommission");
      if (advCommission) advCommission.value = s.commissionPct;
      const grid = $("#advHoldings");
      if (!grid) return;
      grid.innerHTML = "";
      getTradableAssets().forEach(a=>{
        const wrap = document.createElement("div");
        wrap.innerHTML = `
          <div class="p-3 rounded-xl border border-slate-200" style="background: var(--surface);">
            <div class="flex items-center gap-2 mb-2">
              <img src="${imageOf(a.id)||''}" class="w-5 h-5 rounded-md border border-slate-200"/>
              <div class="text-sm font-medium">${a.symbol} • ${a.name}</div>
            </div>
            <input data-hold="${a.id}" type="number" step="0.000001" class="input" value="${s.holdings[a.id] ?? 0}">
          </div>`;
        grid.appendChild(wrap);
      });
    }
    $("#advSaveBasics").addEventListener("click", ()=>{
      const s = loadState();
      s.commissionPct = clamp(+$("#advCommission").value, 0, 100);
      saveState(s);
      updateUI(true);
      alert("Saved.");
    });
    $("#advSaveHoldings").addEventListener("click", ()=>{
      const s = loadState();
      document.querySelectorAll("[data-hold]").forEach(inp=>{
        const id = inp.dataset.hold;
        s.holdings[id] = Math.max(0, +inp.value);
      });
      saveState(s);
      updateUI(true);
      alert("Saved.");
    });
    $("#advReset").addEventListener("click", ()=>{
      if (!confirm("Reset commission and all holdings to defaults?")) return;
      const s = defaultState();
      saveState(s);
      loadAdvancedEditor();
      updateUI(true);
    });

    $("#saveSecurity")?.addEventListener("click", ()=>{
      const sec = loadSec();
      const np = ($("#secNewPass")?.value || "").trim();
      const nk = ($("#secNewKey")?.value || "").trim();
      if (!np && !nk){ alert("Enter a new password and/or key."); return; }
      if (np) sec.password = np;
      if (nk) sec.key = nk;
      saveSec(sec);
      $("#secNewPass").value = ""; $("#secNewKey").value = "";
      alert("Security settings saved. The new password/key will be required next login.");
    });
    $("#saveBoot")?.addEventListener("click", ()=>{
      const v = +($("#bootSeconds")?.value || 3.6);
      saveUI({ bootSeconds: clamp(v, 0.5, 20) });
      alert("Login time updated.");
    });

    function renderAdminDebug(){
      const actBox = $("#adminActivity");
      const trBox = $("#adminTrades");
      if (!actBox || !trBox) return;
      const activity = loadHistory();
      const trades = loadTrades();
      actBox.innerHTML = activity.map(e=>{
        const d = new Date(e.t).toLocaleString();
        return `<div class="flex items-center justify-between"><div>${e.msg}</div><div class="text-[10px] text-slate-500">${d}</div></div>`;
      }).join("") || '<div class="text-slate-500">No activity.</div>';
      trBox.innerHTML = trades.map(tr=>{
        const d = new Date(tr.t).toLocaleString();
        return `<div class="flex items-center justify-between"><div>${tr.fromAmt} ${getSymbol(tr.fromId)} → ${tr.toAmt} ${getSymbol(tr.toId)} • fee ${tr.feePct.toFixed(2)}% • px ${tr.rate}</div><div class="text-[10px] text-slate-500">${d}</div></div>`;
      }).join("") || '<div class="text-slate-500">No trades.</div>';
    }

    /***** FAVORITES & SEARCH *****/
    function addFavorite(asset){
      const favs = loadFavs();
      if (!favs.some(f=>f.id===asset.id)){
        favs.unshift({ id: asset.id, symbol: (asset.symbol||"").toUpperCase(), name: asset.name });
        saveFavs(favs.slice(0,500));
        const s = loadState();
        if (s.holdings[asset.id] == null) { s.holdings[asset.id] = 0; saveState(s); }
        refreshAfterUniverseChange();
      }
    }
    function removeFavorite(id){
      const favs = loadFavs().filter(f=>f.id!==id);
      saveFavs(favs);
      refreshAfterUniverseChange();
    }
    function toggleFavoriteById(id){
      const all = getTradableAssets();
      const found = all.find(a=>a.id===id) || {};
      if (isFav(id)) removeFavorite(id);
      else addFavorite({ id, symbol: found.symbol||id, name: found.name||id });
    }
    async function searchCoinGecko(q){
      if (!q) return [];
      const url = `https://api.coingecko.com/api/v3/search?query=${encodeURIComponent(q)}`;
      const res = await fetch(url, { headers: { "accept": "application/json" }});
      if (!res.ok) return [];
      const data = await res.json();
      return (data.coins||[]).map(c=>({ id:c.id, symbol:c.symbol.toUpperCase(), name:c.name, thumb:c.thumb }));
    }
    function openAssetModal(){
      $("#assetModal").classList.remove("hidden");
      $("#assetSearchInput").focus();
      renderFavoritesPanel();
      $("#assetResults").innerHTML = `<div class="text-slate-500 text-sm">Try searching for “pepe”, “aptos”, “litecoin”…</div>`;
    }
    function closeAssetModal(){ $("#assetModal").classList.add("hidden"); }
    document.querySelectorAll("[data-close-modal]").forEach(el=>el.addEventListener("click", closeAssetModal));
    $("#assetSearchBtn").addEventListener("click", async ()=>{
      const q = $("#assetSearchInput").value.trim();
      const list = await searchCoinGecko(q);
      renderSearchResults(list);
    });
    $("#assetSearchInput").addEventListener("keydown", async (e)=>{
      if (e.key === "Enter"){
        const q = e.currentTarget.value.trim();
        const list = await searchCoinGecko(q);
        renderSearchResults(list);
      }
    });

    function renderSearchResults(list){
      const wrap = $("#assetResults");
      if (!list.length){ wrap.innerHTML = `<div class="text-slate-500 text-sm">No results.</div>`; return; }
      wrap.innerHTML = list.slice(0,100).map(item=>`
        <div class="py-2 flex items-center justify-between">
          <div class="flex items-center gap-2">
            <img src="${item.thumb}" class="w-5 h-5 rounded"/>
            <div><div class="font-medium text-sm">${item.symbol}</div>
            <div class="text-xs text-slate-500">${item.name}</div></div>
          </div>
          <button class="btn" data-add="${item.id}" data-sym="${item.symbol}" data-name="${item.name}">Add</button>
        </div>`).join("");
      wrap.querySelectorAll("[data-add]").forEach(b=>{
        b.addEventListener("click", ()=>{
          addFavorite({ id:b.dataset.add, symbol:b.dataset.sym, name:b.dataset.name });
          renderFavoritesPanel();
        });
      });
    }

    function renderFavoritesPanel(){
      const favs = loadFavs();
      const wrap = $("#favoriteList");
      if (!wrap) return;
      if (!favs.length){ wrap.innerHTML = `<div class="text-slate-500 text-sm">No favorites yet.</div>`; return; }
      wrap.innerHTML = favs.map(f=>`
        <div class="flex items-center justify-between p-2 rounded-lg border" style="background: var(--surface); border-color: var(--border);">
          <div class="font-medium text-sm">${f.symbol} • <span class="text-slate-500">${f.name}</span></div>
          <div class="flex items-center gap-2">
            <button class="btn" data-toggle-fav="${f.id}"><i class="ph ph-star"></i></button>
            <button class="btn" data-remove-fav="${f.id}"><i class="ph ph-trash"></i></button>
          </div>
        </div>`).join("");
      wrap.querySelectorAll("[data-remove-fav]").forEach(b=>b.addEventListener("click", ()=>{ removeFavorite(b.dataset.removeFav); renderFavoritesPanel(); }));
      wrap.querySelectorAll("[data-toggle-fav]").forEach(b=>b.addEventListener("click", ()=>{ toggleFavoriteById(b.dataset.toggleFav); renderFavoritesPanel(); }));
    }

    function refreshAfterUniverseChange(){
      populateSelects();
      updateUI(true);
      renderOpenOrders();
      renderFavoritesPanel();
      updateQuickQuote();
      loadAdvancedEditor();
    }

    /***** THEME / BRAND / UI *****/
    function applyTheme(theme){
      document.documentElement.setAttribute("data-theme", theme);
    }
    function applyBrand(hex){
      const root = document.documentElement;
      const {r,g,b} = hexToRgb(hex);
      root.style.setProperty("--brand", hex);
      root.style.setProperty("--brand-dark", darken(hex, 18));
      root.style.setProperty("--brand-rgb", `${r},${g},${b}`);
      if (chart){
        chart.data.datasets[0].borderColor = hex;
        chart.data.datasets[0].backgroundColor = makeBrandGradient(chart.ctx);
        chart.update("none");
      }
    }
    function applyPadding(px){
      document.documentElement.style.setProperty("--app-x", px+"px");
      $("#uiPaddingVal").textContent = px+"px";
    }

    /***** UI UPDATE & BOOT *****/
    function updateUI(pricesChanged=false){
      const s = loadState();
      if (pricesChanged){
        const nlv = calcNLV(s);
        renderSummary(s);
        if (isFinite(nlv)) { pushChartPoint(nlv); }
        renderPositions(s);
      } else {
        renderSummary(s);
        renderPositions(s);
      }
    }

    function boot(){
      // Show app
      $("#app").classList.remove("opacity-0");

      // Apply UI prefs
      const ui = loadUI();
      applyTheme(ui.theme || "light");
      applyBrand(ui.brandHex || "#0ea5e9");
      applyPadding(ui.paddingPx || 16);
      if ($("#brandColor")) $("#brandColor").value = ui.brandHex || "#0ea5e9";
      if ($("#loginBgCss")) $("#loginBgCss").value = ui.loginBg || "";

      // Wire settings buttons
      $("#saveUI")?.addEventListener("click", ()=>{
        const px = +($("#uiPadding")?.value || 16);
        saveUI({ paddingPx: clamp(px,8,56) });
        applyPadding(clamp(px,8,56));
      });
      $("#themeBtnLight")?.addEventListener("click", ()=>{ document.querySelectorAll('[data-theme]').forEach(b=>b.classList.remove("active")); $("#themeBtnLight").classList.add("active"); });
      $("#themeBtnDark")?.addEventListener("click", ()=>{ document.querySelectorAll('[data-theme]').forEach(b=>b.classList.remove("active")); $("#themeBtnDark").classList.add("active"); });
      $("#saveTheme")?.addEventListener("click", ()=>{
        const chosen = document.querySelector('.seg [data-theme].active')?.dataset.theme || "light";
        saveUI({ theme: chosen }); applyTheme(chosen);
      });
      $("#saveBrand")?.addEventListener("click", ()=>{
        const hex = $("#brandColor")?.value || "#0ea5e9";
        saveUI({ brandHex: hex }); applyBrand(hex);
      });
      $("#loginBgColor")?.addEventListener("input", (e)=>{ const v=e.target.value; if ($("#loginBgCss")) $("#loginBgCss").value = v; });
      $("#saveLoginBg")?.addEventListener("click", ()=>{
        const v = ($("#loginBgCss")?.value || "").trim();
        saveUI({ loginBg: v || null }); applyLoginBg(v || DEFAULT_LOGIN_BG); alert("Login background saved.");
      });
      $("#resetLoginBg")?.addEventListener("click", ()=>{ saveUI({ loginBg: null }); if ($("#loginBgCss")) $("#loginBgCss").value=""; applyLoginBg(DEFAULT_LOGIN_BG); });

      // Export
      $("#exportBtn")?.addEventListener("click", ()=>{
        const blob = new Blob([JSON.stringify({
          state: loadState(),
          trades: loadTrades(),
          history: loadHistory(),
          equity: loadEquity(),
          favs: loadFavs(),
          ui: loadUI(),
          orders: loadOrders()
        }, null, 2)], {type:"application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = "dex-export.json";
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
      });

      populateSelects();
      renderOpenOrders();
      renderFavoritesPanel();
      initChart();
      updateUI(true);

      // Start polling
      const loadAndPoll = async ()=>{
        try{ await fetchMarket(); }catch(e){ /* ignore fetch errors */ }
      };
      loadAndPoll();
      setInterval(loadAndPoll, PRICE_POLL_MS);
    }

    /***** SEARCH UI (complete) *****/
    function renderSearchResultsSafe(list){ renderSearchResults(list); } // alias used above if needed
  </script>
</body>
</html>
